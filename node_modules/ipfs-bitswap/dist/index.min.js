"use strict";(function (root, factory) {(typeof module === 'object' && module.exports) ? module.exports = factory() : root.IpfsBitswap = factory()}(typeof self !== 'undefined' ? self : this, function () {
var IpfsBitswap=(()=>{var ji=Object.create;var qe=Object.defineProperty;var Ui=Object.getOwnPropertyDescriptor;var Wi=Object.getOwnPropertyNames;var Hi=Object.getPrototypeOf,qi=Object.prototype.hasOwnProperty;var y=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports),P=(n,e)=>{for(var t in e)qe(n,t,{get:e[t],enumerable:!0})},Sr=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Wi(e))!qi.call(n,s)&&s!==t&&qe(n,s,{get:()=>e[s],enumerable:!(r=Ui(e,s))||r.enumerable});return n};var M=(n,e,t)=>(t=n!=null?ji(Hi(n)):{},Sr(e||!n||!n.__esModule?qe(t,"default",{value:n,enumerable:!0}):t,n)),Vi=n=>Sr(qe({},"__esModule",{value:!0}),n);var $r=y((su,Vr)=>{Vr.exports=qr;var Hr=128,Lo=127,Fo=~Lo,Po=Math.pow(2,31);function qr(n,e,t){e=e||[],t=t||0;for(var r=t;n>=Po;)e[t++]=n&255|Hr,n/=128;for(;n&Fo;)e[t++]=n&255|Hr,n>>>=7;return e[t]=n|0,qr.bytes=t-r+1,e}});var Qr=y((iu,Jr)=>{Jr.exports=Ot;var No=128,Gr=127;function Ot(n,r){var t=0,r=r||0,s=0,i=r,o,a=n.length;do{if(i>=a)throw Ot.bytes=0,new RangeError("Could not decode varint");o=n[i++],t+=s<28?(o&Gr)<<s:(o&Gr)*Math.pow(2,s),s+=7}while(o>=No);return Ot.bytes=i-r,t}});var Xr=y((ou,Kr)=>{var zo=Math.pow(2,7),Io=Math.pow(2,14),Ro=Math.pow(2,21),jo=Math.pow(2,28),Uo=Math.pow(2,35),Wo=Math.pow(2,42),Ho=Math.pow(2,49),qo=Math.pow(2,56),Vo=Math.pow(2,63);Kr.exports=function(n){return n<zo?1:n<Io?2:n<Ro?3:n<jo?4:n<Uo?5:n<Wo?6:n<Ho?7:n<qo?8:n<Vo?9:10}});var Yr=y((au,Zr)=>{Zr.exports={encode:$r(),decode:Qr(),encodingLength:Xr()}});var rn=y((cu,tn)=>{"use strict";var en=Yr();tn.exports=n=>{if(!(n instanceof Uint8Array))throw new Error("arg needs to be a Uint8Array");let e=[];for(;n.length>0;){let t=en.decode(n);e.push(t),n=n.slice(en.decode.bytes)}return e}});var on=y((uu,sn)=>{sn.exports=Mt;var nn=128,$o=127,Go=~$o,Jo=Math.pow(2,31);function Mt(n,e,t){if(Number.MAX_SAFE_INTEGER&&n>Number.MAX_SAFE_INTEGER)throw Mt.bytes=0,new RangeError("Could not encode varint");e=e||[],t=t||0;for(var r=t;n>=Jo;)e[t++]=n&255|nn,n/=128;for(;n&Go;)e[t++]=n&255|nn,n>>>=7;return e[t]=n|0,Mt.bytes=t-r+1,e}});var un=y((lu,cn)=>{cn.exports=Lt;var Qo=128,an=127;function Lt(n,r){var t=0,r=r||0,s=0,i=r,o,a=n.length;do{if(i>=a||s>49)throw Lt.bytes=0,new RangeError("Could not decode varint");o=n[i++],t+=s<28?(o&an)<<s:(o&an)*Math.pow(2,s),s+=7}while(o>=Qo);return Lt.bytes=i-r,t}});var hn=y((hu,ln)=>{var Ko=Math.pow(2,7),Xo=Math.pow(2,14),Zo=Math.pow(2,21),Yo=Math.pow(2,28),ea=Math.pow(2,35),ta=Math.pow(2,42),ra=Math.pow(2,49),na=Math.pow(2,56),sa=Math.pow(2,63);ln.exports=function(n){return n<Ko?1:n<Xo?2:n<Zo?3:n<Yo?4:n<ea?5:n<ta?6:n<ra?7:n<na?8:n<sa?9:10}});var pn=y((fu,fn)=>{fn.exports={encode:on(),decode:un(),encodingLength:hn()}});var yn=y((du,gn)=>{var _e=1e3,ve=_e*60,ke=ve*60,ue=ke*24,oa=ue*7,aa=ue*365.25;gn.exports=function(n,e){e=e||{};var t=typeof n;if(t==="string"&&n.length>0)return ca(n);if(t==="number"&&isFinite(n))return e.long?la(n):ua(n);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(n))};function ca(n){if(n=String(n),!(n.length>100)){var e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(n);if(!!e){var t=parseFloat(e[1]),r=(e[2]||"ms").toLowerCase();switch(r){case"years":case"year":case"yrs":case"yr":case"y":return t*aa;case"weeks":case"week":case"w":return t*oa;case"days":case"day":case"d":return t*ue;case"hours":case"hour":case"hrs":case"hr":case"h":return t*ke;case"minutes":case"minute":case"mins":case"min":case"m":return t*ve;case"seconds":case"second":case"secs":case"sec":case"s":return t*_e;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return t;default:return}}}}function ua(n){var e=Math.abs(n);return e>=ue?Math.round(n/ue)+"d":e>=ke?Math.round(n/ke)+"h":e>=ve?Math.round(n/ve)+"m":e>=_e?Math.round(n/_e)+"s":n+"ms"}function la(n){var e=Math.abs(n);return e>=ue?Je(n,e,ue,"day"):e>=ke?Je(n,e,ke,"hour"):e>=ve?Je(n,e,ve,"minute"):e>=_e?Je(n,e,_e,"second"):n+" ms"}function Je(n,e,t,r){var s=e>=t*1.5;return Math.round(n/t)+" "+r+(s?"s":"")}});var mn=y((gu,bn)=>{function ha(n){t.debug=t,t.default=t,t.coerce=c,t.disable=i,t.enable=s,t.enabled=o,t.humanize=yn(),t.destroy=u,Object.keys(n).forEach(l=>{t[l]=n[l]}),t.names=[],t.skips=[],t.formatters={};function e(l){let h=0;for(let g=0;g<l.length;g++)h=(h<<5)-h+l.charCodeAt(g),h|=0;return t.colors[Math.abs(h)%t.colors.length]}t.selectColor=e;function t(l){let h,g=null,B,f;function d(...w){if(!d.enabled)return;let x=d,T=Number(new Date),R=T-(h||T);x.diff=R,x.prev=h,x.curr=T,h=T,w[0]=t.coerce(w[0]),typeof w[0]!="string"&&w.unshift("%O");let O=0;w[0]=w[0].replace(/%([a-zA-Z%])/g,(j,F)=>{if(j==="%%")return"%";O++;let U=t.formatters[F];if(typeof U=="function"){let ge=w[O];j=U.call(x,ge),w.splice(O,1),O--}return j}),t.formatArgs.call(x,w),(x.log||t.log).apply(x,w)}return d.namespace=l,d.useColors=t.useColors(),d.color=t.selectColor(l),d.extend=r,d.destroy=t.destroy,Object.defineProperty(d,"enabled",{enumerable:!0,configurable:!1,get:()=>g!==null?g:(B!==t.namespaces&&(B=t.namespaces,f=t.enabled(l)),f),set:w=>{g=w}}),typeof t.init=="function"&&t.init(d),d}function r(l,h){let g=t(this.namespace+(typeof h>"u"?":":h)+l);return g.log=this.log,g}function s(l){t.save(l),t.namespaces=l,t.names=[],t.skips=[];let h,g=(typeof l=="string"?l:"").split(/[\s,]+/),B=g.length;for(h=0;h<B;h++)!g[h]||(l=g[h].replace(/\*/g,".*?"),l[0]==="-"?t.skips.push(new RegExp("^"+l.slice(1)+"$")):t.names.push(new RegExp("^"+l+"$")))}function i(){let l=[...t.names.map(a),...t.skips.map(a).map(h=>"-"+h)].join(",");return t.enable(""),l}function o(l){if(l[l.length-1]==="*")return!0;let h,g;for(h=0,g=t.skips.length;h<g;h++)if(t.skips[h].test(l))return!1;for(h=0,g=t.names.length;h<g;h++)if(t.names[h].test(l))return!0;return!1}function a(l){return l.toString().substring(2,l.toString().length-2).replace(/\.\*\?$/,"*")}function c(l){return l instanceof Error?l.stack||l.message:l}function u(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.enable(t.load()),t}bn.exports=ha});var wn=y((N,Qe)=>{N.formatArgs=pa;N.save=da;N.load=ga;N.useColors=fa;N.storage=ya();N.destroy=(()=>{let n=!1;return()=>{n||(n=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})();N.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function fa(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)?!1:typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function pa(n){if(n[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+n[0]+(this.useColors?"%c ":" ")+"+"+Qe.exports.humanize(this.diff),!this.useColors)return;let e="color: "+this.color;n.splice(1,0,e,"color: inherit");let t=0,r=0;n[0].replace(/%[a-zA-Z%]/g,s=>{s!=="%%"&&(t++,s==="%c"&&(r=t))}),n.splice(r,0,e)}N.log=console.debug||console.log||(()=>{});function da(n){try{n?N.storage.setItem("debug",n):N.storage.removeItem("debug")}catch{}}function ga(){let n;try{n=N.storage.getItem("debug")}catch{}return!n&&typeof process<"u"&&"env"in process&&(n=process.env.DEBUG),n}function ya(){try{return localStorage}catch{}}Qe.exports=mn()(N);var{formatters:ba}=Qe.exports;ba.j=function(n){try{return JSON.stringify(n)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}});var _n=y((wu,Dn)=>{"use strict";Dn.exports=ma;function ma(n,e){for(var t=new Array(arguments.length-1),r=0,s=2,i=!0;s<arguments.length;)t[r++]=arguments[s++];return new Promise(function(a,c){t[r]=function(l){if(i)if(i=!1,l)c(l);else{for(var h=new Array(arguments.length-1),g=0;g<h.length;)h[g++]=arguments[g];a.apply(null,h)}};try{n.apply(e||null,t)}catch(u){i&&(i=!1,c(u))}})}});var Cn=y(En=>{"use strict";var Xe=En;Xe.length=function(e){var t=e.length;if(!t)return 0;for(var r=0;--t%4>1&&e.charAt(t)==="=";)++r;return Math.ceil(e.length*3)/4-r};var Ee=new Array(64),kn=new Array(123);for(V=0;V<64;)kn[Ee[V]=V<26?V+65:V<52?V+71:V<62?V-4:V-59|43]=V++;var V;Xe.encode=function(e,t,r){for(var s=null,i=[],o=0,a=0,c;t<r;){var u=e[t++];switch(a){case 0:i[o++]=Ee[u>>2],c=(u&3)<<4,a=1;break;case 1:i[o++]=Ee[c|u>>4],c=(u&15)<<2,a=2;break;case 2:i[o++]=Ee[c|u>>6],i[o++]=Ee[u&63],a=0;break}o>8191&&((s||(s=[])).push(String.fromCharCode.apply(String,i)),o=0)}return a&&(i[o++]=Ee[c],i[o++]=61,a===1&&(i[o++]=61)),s?(o&&s.push(String.fromCharCode.apply(String,i.slice(0,o))),s.join("")):String.fromCharCode.apply(String,i.slice(0,o))};var vn="invalid encoding";Xe.decode=function(e,t,r){for(var s=r,i=0,o,a=0;a<e.length;){var c=e.charCodeAt(a++);if(c===61&&i>1)break;if((c=kn[c])===void 0)throw Error(vn);switch(i){case 0:o=c,i=1;break;case 1:t[r++]=o<<2|(c&48)>>4,o=c,i=2;break;case 2:t[r++]=(o&15)<<4|(c&60)>>2,o=c,i=3;break;case 3:t[r++]=(o&3)<<6|c,i=0;break}}if(i===1)throw Error(vn);return r-s};Xe.test=function(e){return/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(e)}});var Sn=y((_u,xn)=>{"use strict";xn.exports=Ze;function Ze(){this._listeners={}}Ze.prototype.on=function(e,t,r){return(this._listeners[e]||(this._listeners[e]=[])).push({fn:t,ctx:r||this}),this};Ze.prototype.off=function(e,t){if(e===void 0)this._listeners={};else if(t===void 0)this._listeners[e]=[];else for(var r=this._listeners[e],s=0;s<r.length;)r[s].fn===t?r.splice(s,1):++s;return this};Ze.prototype.emit=function(e){var t=this._listeners[e];if(t){for(var r=[],s=1;s<arguments.length;)r.push(arguments[s++]);for(s=0;s<t.length;)t[s].fn.apply(t[s++].ctx,r)}return this}});var Fn=y((vu,Ln)=>{"use strict";Ln.exports=Bn(Bn);function Bn(n){return typeof Float32Array<"u"?function(){var e=new Float32Array([-0]),t=new Uint8Array(e.buffer),r=t[3]===128;function s(c,u,l){e[0]=c,u[l]=t[0],u[l+1]=t[1],u[l+2]=t[2],u[l+3]=t[3]}function i(c,u,l){e[0]=c,u[l]=t[3],u[l+1]=t[2],u[l+2]=t[1],u[l+3]=t[0]}n.writeFloatLE=r?s:i,n.writeFloatBE=r?i:s;function o(c,u){return t[0]=c[u],t[1]=c[u+1],t[2]=c[u+2],t[3]=c[u+3],e[0]}function a(c,u){return t[3]=c[u],t[2]=c[u+1],t[1]=c[u+2],t[0]=c[u+3],e[0]}n.readFloatLE=r?o:a,n.readFloatBE=r?a:o}():function(){function e(r,s,i,o){var a=s<0?1:0;if(a&&(s=-s),s===0)r(1/s>0?0:2147483648,i,o);else if(isNaN(s))r(2143289344,i,o);else if(s>34028234663852886e22)r((a<<31|2139095040)>>>0,i,o);else if(s<11754943508222875e-54)r((a<<31|Math.round(s/1401298464324817e-60))>>>0,i,o);else{var c=Math.floor(Math.log(s)/Math.LN2),u=Math.round(s*Math.pow(2,-c)*8388608)&8388607;r((a<<31|c+127<<23|u)>>>0,i,o)}}n.writeFloatLE=e.bind(null,An),n.writeFloatBE=e.bind(null,Tn);function t(r,s,i){var o=r(s,i),a=(o>>31)*2+1,c=o>>>23&255,u=o&8388607;return c===255?u?NaN:a*(1/0):c===0?a*1401298464324817e-60*u:a*Math.pow(2,c-150)*(u+8388608)}n.readFloatLE=t.bind(null,On),n.readFloatBE=t.bind(null,Mn)}(),typeof Float64Array<"u"?function(){var e=new Float64Array([-0]),t=new Uint8Array(e.buffer),r=t[7]===128;function s(c,u,l){e[0]=c,u[l]=t[0],u[l+1]=t[1],u[l+2]=t[2],u[l+3]=t[3],u[l+4]=t[4],u[l+5]=t[5],u[l+6]=t[6],u[l+7]=t[7]}function i(c,u,l){e[0]=c,u[l]=t[7],u[l+1]=t[6],u[l+2]=t[5],u[l+3]=t[4],u[l+4]=t[3],u[l+5]=t[2],u[l+6]=t[1],u[l+7]=t[0]}n.writeDoubleLE=r?s:i,n.writeDoubleBE=r?i:s;function o(c,u){return t[0]=c[u],t[1]=c[u+1],t[2]=c[u+2],t[3]=c[u+3],t[4]=c[u+4],t[5]=c[u+5],t[6]=c[u+6],t[7]=c[u+7],e[0]}function a(c,u){return t[7]=c[u],t[6]=c[u+1],t[5]=c[u+2],t[4]=c[u+3],t[3]=c[u+4],t[2]=c[u+5],t[1]=c[u+6],t[0]=c[u+7],e[0]}n.readDoubleLE=r?o:a,n.readDoubleBE=r?a:o}():function(){function e(r,s,i,o,a,c){var u=o<0?1:0;if(u&&(o=-o),o===0)r(0,a,c+s),r(1/o>0?0:2147483648,a,c+i);else if(isNaN(o))r(0,a,c+s),r(2146959360,a,c+i);else if(o>17976931348623157e292)r(0,a,c+s),r((u<<31|2146435072)>>>0,a,c+i);else{var l;if(o<22250738585072014e-324)l=o/5e-324,r(l>>>0,a,c+s),r((u<<31|l/4294967296)>>>0,a,c+i);else{var h=Math.floor(Math.log(o)/Math.LN2);h===1024&&(h=1023),l=o*Math.pow(2,-h),r(l*4503599627370496>>>0,a,c+s),r((u<<31|h+1023<<20|l*1048576&1048575)>>>0,a,c+i)}}}n.writeDoubleLE=e.bind(null,An,0,4),n.writeDoubleBE=e.bind(null,Tn,4,0);function t(r,s,i,o,a){var c=r(o,a+s),u=r(o,a+i),l=(u>>31)*2+1,h=u>>>20&2047,g=4294967296*(u&1048575)+c;return h===2047?g?NaN:l*(1/0):h===0?l*5e-324*g:l*Math.pow(2,h-1075)*(g+4503599627370496)}n.readDoubleLE=t.bind(null,On,0,4),n.readDoubleBE=t.bind(null,Mn,4,0)}(),n}function An(n,e,t){e[t]=n&255,e[t+1]=n>>>8&255,e[t+2]=n>>>16&255,e[t+3]=n>>>24}function Tn(n,e,t){e[t]=n>>>24,e[t+1]=n>>>16&255,e[t+2]=n>>>8&255,e[t+3]=n&255}function On(n,e){return(n[e]|n[e+1]<<8|n[e+2]<<16|n[e+3]<<24)>>>0}function Mn(n,e){return(n[e]<<24|n[e+1]<<16|n[e+2]<<8|n[e+3])>>>0}});var Pn=y((exports,module)=>{"use strict";module.exports=inquire;function inquire(moduleName){try{var mod=eval("quire".replace(/^/,"re"))(moduleName);if(mod&&(mod.length||Object.keys(mod).length))return mod}catch(n){}return null}});var zn=y(Nn=>{"use strict";var Ft=Nn;Ft.length=function(e){for(var t=0,r=0,s=0;s<e.length;++s)r=e.charCodeAt(s),r<128?t+=1:r<2048?t+=2:(r&64512)===55296&&(e.charCodeAt(s+1)&64512)===56320?(++s,t+=4):t+=3;return t};Ft.read=function(e,t,r){var s=r-t;if(s<1)return"";for(var i=null,o=[],a=0,c;t<r;)c=e[t++],c<128?o[a++]=c:c>191&&c<224?o[a++]=(c&31)<<6|e[t++]&63:c>239&&c<365?(c=((c&7)<<18|(e[t++]&63)<<12|(e[t++]&63)<<6|e[t++]&63)-65536,o[a++]=55296+(c>>10),o[a++]=56320+(c&1023)):o[a++]=(c&15)<<12|(e[t++]&63)<<6|e[t++]&63,a>8191&&((i||(i=[])).push(String.fromCharCode.apply(String,o)),a=0);return i?(a&&i.push(String.fromCharCode.apply(String,o.slice(0,a))),i.join("")):String.fromCharCode.apply(String,o.slice(0,a))};Ft.write=function(e,t,r){for(var s=r,i,o,a=0;a<e.length;++a)i=e.charCodeAt(a),i<128?t[r++]=i:i<2048?(t[r++]=i>>6|192,t[r++]=i&63|128):(i&64512)===55296&&((o=e.charCodeAt(a+1))&64512)===56320?(i=65536+((i&1023)<<10)+(o&1023),++a,t[r++]=i>>18|240,t[r++]=i>>12&63|128,t[r++]=i>>6&63|128,t[r++]=i&63|128):(t[r++]=i>>12|224,t[r++]=i>>6&63|128,t[r++]=i&63|128);return r-s}});var Rn=y((Eu,In)=>{"use strict";In.exports=wa;function wa(n,e,t){var r=t||8192,s=r>>>1,i=null,o=r;return function(c){if(c<1||c>s)return n(c);o+c>r&&(i=n(r),o=0);var u=e.call(i,o,o+=c);return o&7&&(o=(o|7)+1),u}}});var Un=y((Cu,jn)=>{"use strict";jn.exports=A;var Fe=se();function A(n,e){this.lo=n>>>0,this.hi=e>>>0}var le=A.zero=new A(0,0);le.toNumber=function(){return 0};le.zzEncode=le.zzDecode=function(){return this};le.length=function(){return 1};var Da=A.zeroHash="\0\0\0\0\0\0\0\0";A.fromNumber=function(e){if(e===0)return le;var t=e<0;t&&(e=-e);var r=e>>>0,s=(e-r)/4294967296>>>0;return t&&(s=~s>>>0,r=~r>>>0,++r>4294967295&&(r=0,++s>4294967295&&(s=0))),new A(r,s)};A.from=function(e){if(typeof e=="number")return A.fromNumber(e);if(Fe.isString(e))if(Fe.Long)e=Fe.Long.fromString(e);else return A.fromNumber(parseInt(e,10));return e.low||e.high?new A(e.low>>>0,e.high>>>0):le};A.prototype.toNumber=function(e){if(!e&&this.hi>>>31){var t=~this.lo+1>>>0,r=~this.hi>>>0;return t||(r=r+1>>>0),-(t+r*4294967296)}return this.lo+this.hi*4294967296};A.prototype.toLong=function(e){return Fe.Long?new Fe.Long(this.lo|0,this.hi|0,Boolean(e)):{low:this.lo|0,high:this.hi|0,unsigned:Boolean(e)}};var ne=String.prototype.charCodeAt;A.fromHash=function(e){return e===Da?le:new A((ne.call(e,0)|ne.call(e,1)<<8|ne.call(e,2)<<16|ne.call(e,3)<<24)>>>0,(ne.call(e,4)|ne.call(e,5)<<8|ne.call(e,6)<<16|ne.call(e,7)<<24)>>>0)};A.prototype.toHash=function(){return String.fromCharCode(this.lo&255,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,this.hi&255,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)};A.prototype.zzEncode=function(){var e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this};A.prototype.zzDecode=function(){var e=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this};A.prototype.length=function(){var e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,r=this.hi>>>24;return r===0?t===0?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:r<128?9:10}});var se=y(Pt=>{"use strict";var p=Pt;p.asPromise=_n();p.base64=Cn();p.EventEmitter=Sn();p.float=Fn();p.inquire=Pn();p.utf8=zn();p.pool=Rn();p.LongBits=Un();p.isNode=Boolean(typeof globalThis<"u"&&globalThis&&globalThis.process&&globalThis.process.versions&&globalThis.process.versions.node);p.global=p.isNode&&globalThis||typeof window<"u"&&window||typeof self<"u"&&self||Pt;p.emptyArray=Object.freeze?Object.freeze([]):[];p.emptyObject=Object.freeze?Object.freeze({}):{};p.isInteger=Number.isInteger||function(e){return typeof e=="number"&&isFinite(e)&&Math.floor(e)===e};p.isString=function(e){return typeof e=="string"||e instanceof String};p.isObject=function(e){return e&&typeof e=="object"};p.isset=p.isSet=function(e,t){var r=e[t];return r!=null&&e.hasOwnProperty(t)?typeof r!="object"||(Array.isArray(r)?r.length:Object.keys(r).length)>0:!1};p.Buffer=function(){try{var n=p.inquire("buffer").Buffer;return n.prototype.utf8Write?n:null}catch{return null}}();p._Buffer_from=null;p._Buffer_allocUnsafe=null;p.newBuffer=function(e){return typeof e=="number"?p.Buffer?p._Buffer_allocUnsafe(e):new p.Array(e):p.Buffer?p._Buffer_from(e):typeof Uint8Array>"u"?e:new Uint8Array(e)};p.Array=typeof Uint8Array<"u"?Uint8Array:Array;p.Long=p.global.dcodeIO&&p.global.dcodeIO.Long||p.global.Long||p.inquire("long");p.key2Re=/^true|false|0|1$/;p.key32Re=/^-?(?:0|[1-9][0-9]*)$/;p.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/;p.longToHash=function(e){return e?p.LongBits.from(e).toHash():p.LongBits.zeroHash};p.longFromHash=function(e,t){var r=p.LongBits.fromHash(e);return p.Long?p.Long.fromBits(r.lo,r.hi,t):r.toNumber(Boolean(t))};function Wn(n,e,t){for(var r=Object.keys(e),s=0;s<r.length;++s)(n[r[s]]===void 0||!t)&&(n[r[s]]=e[r[s]]);return n}p.merge=Wn;p.lcFirst=function(e){return e.charAt(0).toLowerCase()+e.substring(1)};function Hn(n){function e(t,r){if(!(this instanceof e))return new e(t,r);Object.defineProperty(this,"message",{get:function(){return t}}),Error.captureStackTrace?Error.captureStackTrace(this,e):Object.defineProperty(this,"stack",{value:new Error().stack||""}),r&&Wn(this,r)}return e.prototype=Object.create(Error.prototype,{constructor:{value:e,writable:!0,enumerable:!1,configurable:!0},name:{get(){return n},set:void 0,enumerable:!1,configurable:!0},toString:{value(){return this.name+": "+this.message},writable:!0,enumerable:!1,configurable:!0}}),e}p.newError=Hn;p.ProtocolError=Hn("ProtocolError");p.oneOfGetter=function(e){for(var t={},r=0;r<e.length;++r)t[e[r]]=1;return function(){for(var s=Object.keys(this),i=s.length-1;i>-1;--i)if(t[s[i]]===1&&this[s[i]]!==void 0&&this[s[i]]!==null)return s[i]}};p.oneOfSetter=function(e){return function(t){for(var r=0;r<e.length;++r)e[r]!==t&&delete this[e[r]]}};p.toJSONOptions={longs:String,enums:String,bytes:String,json:!0};p._configure=function(){var n=p.Buffer;if(!n){p._Buffer_from=p._Buffer_allocUnsafe=null;return}p._Buffer_from=n.from!==Uint8Array.from&&n.from||function(t,r){return new n(t,r)},p._Buffer_allocUnsafe=n.allocUnsafe||function(t){return new n(t)}}});var Wt=y((Su,Gn)=>{"use strict";Gn.exports=m;var W=se(),Nt,Ye=W.LongBits,qn=W.base64,Vn=W.utf8;function Pe(n,e,t){this.fn=n,this.len=e,this.next=void 0,this.val=t}function It(){}function _a(n){this.head=n.head,this.tail=n.tail,this.len=n.len,this.next=n.states}function m(){this.len=0,this.head=new Pe(It,0,0),this.tail=this.head,this.states=null}var $n=function(){return W.Buffer?function(){return(m.create=function(){return new Nt})()}:function(){return new m}};m.create=$n();m.alloc=function(e){return new W.Array(e)};W.Array!==Array&&(m.alloc=W.pool(m.alloc,W.Array.prototype.subarray));m.prototype._push=function(e,t,r){return this.tail=this.tail.next=new Pe(e,t,r),this.len+=t,this};function Rt(n,e,t){e[t]=n&255}function va(n,e,t){for(;n>127;)e[t++]=n&127|128,n>>>=7;e[t]=n}function jt(n,e){this.len=n,this.next=void 0,this.val=e}jt.prototype=Object.create(Pe.prototype);jt.prototype.fn=va;m.prototype.uint32=function(e){return this.len+=(this.tail=this.tail.next=new jt((e=e>>>0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this};m.prototype.int32=function(e){return e<0?this._push(Ut,10,Ye.fromNumber(e)):this.uint32(e)};m.prototype.sint32=function(e){return this.uint32((e<<1^e>>31)>>>0)};function Ut(n,e,t){for(;n.hi;)e[t++]=n.lo&127|128,n.lo=(n.lo>>>7|n.hi<<25)>>>0,n.hi>>>=7;for(;n.lo>127;)e[t++]=n.lo&127|128,n.lo=n.lo>>>7;e[t++]=n.lo}m.prototype.uint64=function(e){var t=Ye.from(e);return this._push(Ut,t.length(),t)};m.prototype.int64=m.prototype.uint64;m.prototype.sint64=function(e){var t=Ye.from(e).zzEncode();return this._push(Ut,t.length(),t)};m.prototype.bool=function(e){return this._push(Rt,1,e?1:0)};function zt(n,e,t){e[t]=n&255,e[t+1]=n>>>8&255,e[t+2]=n>>>16&255,e[t+3]=n>>>24}m.prototype.fixed32=function(e){return this._push(zt,4,e>>>0)};m.prototype.sfixed32=m.prototype.fixed32;m.prototype.fixed64=function(e){var t=Ye.from(e);return this._push(zt,4,t.lo)._push(zt,4,t.hi)};m.prototype.sfixed64=m.prototype.fixed64;m.prototype.float=function(e){return this._push(W.float.writeFloatLE,4,e)};m.prototype.double=function(e){return this._push(W.float.writeDoubleLE,8,e)};var ka=W.Array.prototype.set?function(e,t,r){t.set(e,r)}:function(e,t,r){for(var s=0;s<e.length;++s)t[r+s]=e[s]};m.prototype.bytes=function(e){var t=e.length>>>0;if(!t)return this._push(Rt,1,0);if(W.isString(e)){var r=m.alloc(t=qn.length(e));qn.decode(e,r,0),e=r}return this.uint32(t)._push(ka,t,e)};m.prototype.string=function(e){var t=Vn.length(e);return t?this.uint32(t)._push(Vn.write,t,e):this._push(Rt,1,0)};m.prototype.fork=function(){return this.states=new _a(this),this.head=this.tail=new Pe(It,0,0),this.len=0,this};m.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new Pe(It,0,0),this.len=0),this};m.prototype.ldelim=function(){var e=this.head,t=this.tail,r=this.len;return this.reset().uint32(r),r&&(this.tail.next=e.next,this.tail=t,this.len+=r),this};m.prototype.finish=function(){for(var e=this.head.next,t=this.constructor.alloc(this.len),r=0;e;)e.fn(e.val,t,r),r+=e.len,e=e.next;return t};m._configure=function(n){Nt=n,m.create=$n(),Nt._configure()}});var Kn=y((Bu,Qn)=>{"use strict";Qn.exports=Q;var Jn=Wt();(Q.prototype=Object.create(Jn.prototype)).constructor=Q;var ie=se();function Q(){Jn.call(this)}Q._configure=function(){Q.alloc=ie._Buffer_allocUnsafe,Q.writeBytesBuffer=ie.Buffer&&ie.Buffer.prototype instanceof Uint8Array&&ie.Buffer.prototype.set.name==="set"?function(e,t,r){t.set(e,r)}:function(e,t,r){if(e.copy)e.copy(t,r,0,e.length);else for(var s=0;s<e.length;)t[r++]=e[s++]}};Q.prototype.bytes=function(e){ie.isString(e)&&(e=ie._Buffer_from(e,"base64"));var t=e.length>>>0;return this.uint32(t),t&&this._push(Q.writeBytesBuffer,t,e),this};function Ea(n,e,t){n.length<40?ie.utf8.write(n,e,t):e.utf8Write?e.utf8Write(n,t):e.write(n,t)}Q.prototype.string=function(e){var t=ie.Buffer.byteLength(e);return this.uint32(t),t&&this._push(Ea,t,e),this};Q._configure()});var Vt=y((Au,ts)=>{"use strict";ts.exports=S;var K=se(),qt,Yn=K.LongBits,Ca=K.utf8;function $(n,e){return RangeError("index out of range: "+n.pos+" + "+(e||1)+" > "+n.len)}function S(n){this.buf=n,this.pos=0,this.len=n.length}var Xn=typeof Uint8Array<"u"?function(e){if(e instanceof Uint8Array||Array.isArray(e))return new S(e);throw Error("illegal buffer")}:function(e){if(Array.isArray(e))return new S(e);throw Error("illegal buffer")},es=function(){return K.Buffer?function(t){return(S.create=function(s){return K.Buffer.isBuffer(s)?new qt(s):Xn(s)})(t)}:Xn};S.create=es();S.prototype._slice=K.Array.prototype.subarray||K.Array.prototype.slice;S.prototype.uint32=function(){var e=4294967295;return function(){if(e=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(e=(e|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return e;if((this.pos+=5)>this.len)throw this.pos=this.len,$(this,10);return e}}();S.prototype.int32=function(){return this.uint32()|0};S.prototype.sint32=function(){var e=this.uint32();return e>>>1^-(e&1)|0};function Ht(){var n=new Yn(0,0),e=0;if(this.len-this.pos>4){for(;e<4;++e)if(n.lo=(n.lo|(this.buf[this.pos]&127)<<e*7)>>>0,this.buf[this.pos++]<128)return n;if(n.lo=(n.lo|(this.buf[this.pos]&127)<<28)>>>0,n.hi=(n.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return n;e=0}else{for(;e<3;++e){if(this.pos>=this.len)throw $(this);if(n.lo=(n.lo|(this.buf[this.pos]&127)<<e*7)>>>0,this.buf[this.pos++]<128)return n}return n.lo=(n.lo|(this.buf[this.pos++]&127)<<e*7)>>>0,n}if(this.len-this.pos>4){for(;e<5;++e)if(n.hi=(n.hi|(this.buf[this.pos]&127)<<e*7+3)>>>0,this.buf[this.pos++]<128)return n}else for(;e<5;++e){if(this.pos>=this.len)throw $(this);if(n.hi=(n.hi|(this.buf[this.pos]&127)<<e*7+3)>>>0,this.buf[this.pos++]<128)return n}throw Error("invalid varint encoding")}S.prototype.bool=function(){return this.uint32()!==0};function et(n,e){return(n[e-4]|n[e-3]<<8|n[e-2]<<16|n[e-1]<<24)>>>0}S.prototype.fixed32=function(){if(this.pos+4>this.len)throw $(this,4);return et(this.buf,this.pos+=4)};S.prototype.sfixed32=function(){if(this.pos+4>this.len)throw $(this,4);return et(this.buf,this.pos+=4)|0};function Zn(){if(this.pos+8>this.len)throw $(this,8);return new Yn(et(this.buf,this.pos+=4),et(this.buf,this.pos+=4))}S.prototype.float=function(){if(this.pos+4>this.len)throw $(this,4);var e=K.float.readFloatLE(this.buf,this.pos);return this.pos+=4,e};S.prototype.double=function(){if(this.pos+8>this.len)throw $(this,4);var e=K.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,e};S.prototype.bytes=function(){var e=this.uint32(),t=this.pos,r=this.pos+e;if(r>this.len)throw $(this,e);return this.pos+=e,Array.isArray(this.buf)?this.buf.slice(t,r):t===r?new this.buf.constructor(0):this._slice.call(this.buf,t,r)};S.prototype.string=function(){var e=this.bytes();return Ca.read(e,0,e.length)};S.prototype.skip=function(e){if(typeof e=="number"){if(this.pos+e>this.len)throw $(this,e);this.pos+=e}else do if(this.pos>=this.len)throw $(this);while(this.buf[this.pos++]&128);return this};S.prototype.skipType=function(n){switch(n){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(n=this.uint32()&7)!==4;)this.skipType(n);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+n+" at offset "+this.pos)}return this};S._configure=function(n){qt=n,S.create=es(),qt._configure();var e=K.Long?"toLong":"toNumber";K.merge(S.prototype,{int64:function(){return Ht.call(this)[e](!1)},uint64:function(){return Ht.call(this)[e](!0)},sint64:function(){return Ht.call(this).zzDecode()[e](!1)},fixed64:function(){return Zn.call(this)[e](!0)},sfixed64:function(){return Zn.call(this)[e](!1)}})}});var is=y((Tu,ss)=>{"use strict";ss.exports=he;var ns=Vt();(he.prototype=Object.create(ns.prototype)).constructor=he;var rs=se();function he(n){ns.call(this,n)}he._configure=function(){rs.Buffer&&(he.prototype._slice=rs.Buffer.prototype.slice)};he.prototype.string=function(){var e=this.uint32();return this.buf.utf8Slice?this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+e,this.len)):this.buf.toString("utf-8",this.pos,this.pos=Math.min(this.pos+e,this.len))};he._configure()});var as=y((Ou,os)=>{"use strict";os.exports=Ne;var $t=se();(Ne.prototype=Object.create($t.EventEmitter.prototype)).constructor=Ne;function Ne(n,e,t){if(typeof n!="function")throw TypeError("rpcImpl must be a function");$t.EventEmitter.call(this),this.rpcImpl=n,this.requestDelimited=Boolean(e),this.responseDelimited=Boolean(t)}Ne.prototype.rpcCall=function n(e,t,r,s,i){if(!s)throw TypeError("request must be specified");var o=this;if(!i)return $t.asPromise(n,o,e,t,r,s);if(!o.rpcImpl){setTimeout(function(){i(Error("already ended"))},0);return}try{return o.rpcImpl(e,t[o.requestDelimited?"encodeDelimited":"encode"](s).finish(),function(c,u){if(c)return o.emit("error",c,e),i(c);if(u===null){o.end(!0);return}if(!(u instanceof r))try{u=r[o.responseDelimited?"decodeDelimited":"decode"](u)}catch(l){return o.emit("error",l,e),i(l)}return o.emit("data",u,e),i(null,u)})}catch(a){o.emit("error",a,e),setTimeout(function(){i(a)},0);return}};Ne.prototype.end=function(e){return this.rpcImpl&&(e||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this}});var us=y(cs=>{"use strict";var xa=cs;xa.Service=as()});var hs=y((Lu,ls)=>{"use strict";ls.exports={}});var ds=y(ps=>{"use strict";var L=ps;L.build="minimal";L.Writer=Wt();L.BufferWriter=Kn();L.Reader=Vt();L.BufferReader=is();L.util=se();L.rpc=us();L.roots=hs();L.configure=fs;function fs(){L.util._configure(),L.Writer._configure(L.BufferWriter),L.Reader._configure(L.BufferReader)}fs()});var ys=y((Pu,gs)=>{"use strict";gs.exports=ds()});var Qt=y((Qu,ws)=>{"use strict";function ms(n,e){for(let t in e)Object.defineProperty(n,t,{value:e[t],enumerable:!0,configurable:!0});return n}function Aa(n,e,t){if(!n||typeof n=="string")throw new TypeError("Please pass an Error to err-code");t||(t={}),typeof e=="object"&&(t=e,e=""),e&&(t.code=e);try{return ms(n,t)}catch{t.message=n.message,t.stack=n.stack;let s=function(){};return s.prototype=Object.create(Object.getPrototypeOf(n)),ms(new s,t)}}ws.exports=Aa});var Ms=y((ql,Os)=>{Os.exports=class{constructor(e){if(!(e>0)||(e-1&e)!==0)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){let e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}peek(){return this.buffer[this.btm]}isEmpty(){return this.buffer[this.btm]===void 0}}});var Ps=y(($l,Fs)=>{var Ls=Ms();Fs.exports=class{constructor(e){this.hwm=e||16,this.head=new Ls(this.hwm),this.tail=this.head}push(e){if(!this.head.push(e)){let t=this.head;this.head=t.next=new Ls(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next){let t=this.tail.next;return this.tail.next=null,this.tail=t,this.tail.shift()}return e}peek(){return this.tail.peek()}isEmpty(){return this.head.isEmpty()}}});var zs=y((Gl,Ns)=>{var er=Ps();Ns.exports=n=>{n=n||{};let e;typeof n=="function"?(e=n,n={}):e=n.onEnd;let t=new er,r,s,i,o=()=>{if(!t.isEmpty()){if(n.writev){let d,w=[];for(;!t.isEmpty();){if(d=t.shift(),d.error)throw d.error;w.push(d.value)}return{done:d.done,value:w}}let f=t.shift();if(f.error)throw f.error;return f}return i?{done:!0}:new Promise((f,d)=>{s=w=>(s=null,w.error?d(w.error):n.writev&&!w.done?f({done:w.done,value:[w.value]}):f(w),r)})},a=f=>s?s(f):(t.push(f),r),c=f=>(t=new er,s?s({error:f}):(t.push({error:f}),r)),u=f=>i?r:a({done:!1,value:f}),l=f=>i?r:(i=!0,f?c(f):a({done:!0})),h=()=>(t=new er,l(),{done:!0}),g=f=>(l(f),{done:!0});if(r={[Symbol.asyncIterator](){return this},next:o,return:h,throw:g,push:u,end:l},!e)return r;let B=r;return r={[Symbol.asyncIterator](){return this},next(){return B.next()},throw(f){return B.throw(f),e&&(e(f),e=null),{done:!0}},return(){return B.return(),e&&(e(),e=null),{done:!0}},push:u,end(f){return B.end(f),e&&(e(f),e=null),r}},r}});var Rs=y((Jl,Is)=>{"use strict";var qa=zs(),Va=async function*(...n){let e=qa();setTimeout(async()=>{try{await Promise.all(n.map(async t=>{for await(let r of t)e.push(r)})),e.end()}catch(t){e.end(t)}},0),yield*e};Is.exports=Va});var Vs=y((eh,qs)=>{"use strict";qs.exports=function(){return Date.now()}});var Gs=y((th,$s)=>{"use strict";var ct=Vs(),ir=class{constructor(e,t,r){let s=this;this._started=ct(),this._rescheduled=0,this._scheduled=t,this._args=r,this._triggered=!1,this._timerWrapper=()=>{s._rescheduled>0?(s._scheduled=s._rescheduled-(ct()-s._started),s._schedule(s._scheduled)):(s._triggered=!0,e.apply(null,s._args))},this._timer=setTimeout(this._timerWrapper,t)}reschedule(e){e||(e=this._scheduled);let t=ct();t+e-(this._started+this._scheduled)<0?(clearTimeout(this._timer),this._schedule(e)):this._triggered?this._schedule(e):(this._started=t,this._rescheduled=e)}_schedule(e){this._triggered=!1,this._started=ct(),this._rescheduled=0,this._scheduled=e,this._timer=setTimeout(this._timerWrapper,e)}clear(){clearTimeout(this._timer)}};function Ja(){if(typeof arguments[0]!="function")throw new Error("callback needed");if(typeof arguments[1]!="number")throw new Error("timeout needed");let n;if(arguments.length>0){n=new Array(arguments.length-2);for(var e=0;e<n.length;e++)n[e]=arguments[e+2]}return new ir(arguments[0],arguments[1],n)}$s.exports=Ja});var Ks=y((rh,Qs)=>{"use strict";var{AbortController:Qa}=globalThis,Js=Gs(),je=class extends Qa{constructor(e){super(),this._ms=e,this._timer=Js(()=>this.abort(),e),Object.setPrototypeOf(this,je.prototype)}abort(){return this._timer.clear(),super.abort()}clear(){this._timer.clear()}reset(){this._timer.clear(),this._timer=Js(()=>this.abort(),this._ms)}};Qs.exports={TimeoutController:je}});var yt=y((Th,lr)=>{"use strict";var xe=typeof Reflect=="object"?Reflect:null,ri=xe&&typeof xe.apply=="function"?xe.apply:function(e,t,r){return Function.prototype.apply.call(e,t,r)},dt;xe&&typeof xe.ownKeys=="function"?dt=xe.ownKeys:Object.getOwnPropertySymbols?dt=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:dt=function(e){return Object.getOwnPropertyNames(e)};function sc(n){console&&console.warn&&console.warn(n)}var si=Number.isNaN||function(e){return e!==e};function E(){E.init.call(this)}lr.exports=E;lr.exports.once=cc;E.EventEmitter=E;E.prototype._events=void 0;E.prototype._eventsCount=0;E.prototype._maxListeners=void 0;var ni=10;function gt(n){if(typeof n!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof n)}Object.defineProperty(E,"defaultMaxListeners",{enumerable:!0,get:function(){return ni},set:function(n){if(typeof n!="number"||n<0||si(n))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+n+".");ni=n}});E.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};E.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||si(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function ii(n){return n._maxListeners===void 0?E.defaultMaxListeners:n._maxListeners}E.prototype.getMaxListeners=function(){return ii(this)};E.prototype.emit=function(e){for(var t=[],r=1;r<arguments.length;r++)t.push(arguments[r]);var s=e==="error",i=this._events;if(i!==void 0)s=s&&i.error===void 0;else if(!s)return!1;if(s){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var c=i[e];if(c===void 0)return!1;if(typeof c=="function")ri(c,this,t);else for(var u=c.length,l=li(c,u),r=0;r<u;++r)ri(l[r],this,t);return!0};function oi(n,e,t,r){var s,i,o;if(gt(t),i=n._events,i===void 0?(i=n._events=Object.create(null),n._eventsCount=0):(i.newListener!==void 0&&(n.emit("newListener",e,t.listener?t.listener:t),i=n._events),o=i[e]),o===void 0)o=i[e]=t,++n._eventsCount;else if(typeof o=="function"?o=i[e]=r?[t,o]:[o,t]:r?o.unshift(t):o.push(t),s=ii(n),s>0&&o.length>s&&!o.warned){o.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=n,a.type=e,a.count=o.length,sc(a)}return n}E.prototype.addListener=function(e,t){return oi(this,e,t,!1)};E.prototype.on=E.prototype.addListener;E.prototype.prependListener=function(e,t){return oi(this,e,t,!0)};function ic(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function ai(n,e,t){var r={fired:!1,wrapFn:void 0,target:n,type:e,listener:t},s=ic.bind(r);return s.listener=t,r.wrapFn=s,s}E.prototype.once=function(e,t){return gt(t),this.on(e,ai(this,e,t)),this};E.prototype.prependOnceListener=function(e,t){return gt(t),this.prependListener(e,ai(this,e,t)),this};E.prototype.removeListener=function(e,t){var r,s,i,o,a;if(gt(t),s=this._events,s===void 0)return this;if(r=s[e],r===void 0)return this;if(r===t||r.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete s[e],s.removeListener&&this.emit("removeListener",e,r.listener||t));else if(typeof r!="function"){for(i=-1,o=r.length-1;o>=0;o--)if(r[o]===t||r[o].listener===t){a=r[o].listener,i=o;break}if(i<0)return this;i===0?r.shift():oc(r,i),r.length===1&&(s[e]=r[0]),s.removeListener!==void 0&&this.emit("removeListener",e,a||t)}return this};E.prototype.off=E.prototype.removeListener;E.prototype.removeAllListeners=function(e){var t,r,s;if(r=this._events,r===void 0)return this;if(r.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):r[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete r[e]),this;if(arguments.length===0){var i=Object.keys(r),o;for(s=0;s<i.length;++s)o=i[s],o!=="removeListener"&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=r[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(s=t.length-1;s>=0;s--)this.removeListener(e,t[s]);return this};function ci(n,e,t){var r=n._events;if(r===void 0)return[];var s=r[e];return s===void 0?[]:typeof s=="function"?t?[s.listener||s]:[s]:t?ac(s):li(s,s.length)}E.prototype.listeners=function(e){return ci(this,e,!0)};E.prototype.rawListeners=function(e){return ci(this,e,!1)};E.listenerCount=function(n,e){return typeof n.listenerCount=="function"?n.listenerCount(e):ui.call(n,e)};E.prototype.listenerCount=ui;function ui(n){var e=this._events;if(e!==void 0){var t=e[n];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}E.prototype.eventNames=function(){return this._eventsCount>0?dt(this._events):[]};function li(n,e){for(var t=new Array(e),r=0;r<e;++r)t[r]=n[r];return t}function oc(n,e){for(;e+1<n.length;e++)n[e]=n[e+1];n.pop()}function ac(n){for(var e=new Array(n.length),t=0;t<e.length;++t)e[t]=n[t].listener||n[t];return e}function cc(n,e){return new Promise(function(t,r){function s(o){n.removeListener(e,i),r(o)}function i(){typeof n.removeListener=="function"&&n.removeListener("error",s),t([].slice.call(arguments))}hi(n,e,i,{once:!0}),e!=="error"&&uc(n,s,{once:!0})})}function uc(n,e,t){typeof n.on=="function"&&hi(n,"error",e,t)}function hi(n,e,t,r){if(typeof n.on=="function")r.once?n.once(e,t):n.on(e,t);else if(typeof n.addEventListener=="function")n.addEventListener(e,function s(i){r.once&&n.removeEventListener(e,s),t(i)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof n)}});var ki=y((_i,vi)=>{"use strict";var Lc=Math.exp;_i=vi.exports=function(e){if(typeof e!="number")throw new Error("must provide a timespan to the moving average constructor");if(e<=0)throw new Error("must provide a timespan > 0 to the moving average constructor");let t,r=0,s=0,i=0,o,a={};function c(u,l){return 1-Lc(-(u-l)/e)}return a.push=function(l,h){if(o){let g=c(l,o),B=h-t,f=g*B;t=g*h+(1-g)*t,r=(1-g)*(r+B*f),s=Math.sqrt(r),i=t+g*B}else t=h;o=l},a.movingAverage=function(){return t},a.variance=function(){return r},a.deviation=function(){return s},a.forecast=function(){return i},a}});var Bi=y((cf,Er)=>{function Si(n){let e=new globalThis.AbortController;function t(){e.abort();for(let r of n)!r||!r.removeEventListener||r.removeEventListener("abort",t)}for(let r of n)if(!(!r||!r.addEventListener)){if(r.aborted){t();break}r.addEventListener("abort",t)}return e.signal}Er.exports=Si;Er.exports.anySignal=Si});var Ti=y((uf,Ai)=>{"use strict";var Fc=async n=>{for await(let e of n);};Ai.exports=Fc});var Mi=y((lf,Oi)=>{"use strict";var Pc=async function*(n,e){for await(let t of n)await e(t)&&(yield t)};Oi.exports=Pc});var Fi=y((hf,Li)=>{"use strict";var Nc=async function*(n,e){let t=0;if(!(e<1)){for await(let r of n)if(yield r,t++,t===e)return}};Li.exports=Nc});var Ni=y((ff,Pi)=>{"use strict";var zc=async n=>{let e=[];for await(let t of n)e.push(t);return e};Pi.exports=zc});var Uc={};P(Uc,{createBitswap:()=>jc});var $i=Tr,Br=128,Gi=127,Ji=~Gi,Qi=Math.pow(2,31);function Tr(n,e,t){e=e||[],t=t||0;for(var r=t;n>=Qi;)e[t++]=n&255|Br,n/=128;for(;n&Ji;)e[t++]=n&255|Br,n>>>=7;return e[t]=n|0,Tr.bytes=t-r+1,e}var Ki=_t,Xi=128,Ar=127;function _t(n,r){var t=0,r=r||0,s=0,i=r,o,a=n.length;do{if(i>=a)throw _t.bytes=0,new RangeError("Could not decode varint");o=n[i++],t+=s<28?(o&Ar)<<s:(o&Ar)*Math.pow(2,s),s+=7}while(o>=Xi);return _t.bytes=i-r,t}var Zi=Math.pow(2,7),Yi=Math.pow(2,14),eo=Math.pow(2,21),to=Math.pow(2,28),ro=Math.pow(2,35),no=Math.pow(2,42),so=Math.pow(2,49),io=Math.pow(2,56),oo=Math.pow(2,63),ao=function(n){return n<Zi?1:n<Yi?2:n<eo?3:n<to?4:n<ro?5:n<no?6:n<so?7:n<io?8:n<oo?9:10},co={encode:$i,decode:Ki,encodingLength:ao},uo=co,Se=uo;var Be=(n,e=0)=>[Se.decode(n,e),Se.decode.bytes],ye=(n,e,t=0)=>(Se.encode(n,e,t),e),be=n=>Se.encodingLength(n);var Vc=new Uint8Array(0);var Or=(n,e)=>{if(n===e)return!0;if(n.byteLength!==e.byteLength)return!1;for(let t=0;t<n.byteLength;t++)if(n[t]!==e[t])return!1;return!0},Y=n=>{if(n instanceof Uint8Array&&n.constructor.name==="Uint8Array")return n;if(n instanceof ArrayBuffer)return new Uint8Array(n);if(ArrayBuffer.isView(n))return new Uint8Array(n.buffer,n.byteOffset,n.byteLength);throw new Error("Unknown type, must be binary type")};var Mr=n=>new TextEncoder().encode(n),Lr=n=>new TextDecoder().decode(n);var ce=(n,e)=>{let t=e.byteLength,r=be(n),s=r+be(t),i=new Uint8Array(s+t);return ye(n,i,0),ye(t,i,r),i.set(e,s),new me(n,t,e,i)},Pr=n=>{let e=Y(n),[t,r]=Be(e),[s,i]=Be(e.subarray(r)),o=e.subarray(r+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new me(t,s,o,e)},Nr=(n,e)=>n===e?!0:n.code===e.code&&n.size===e.size&&Or(n.bytes,e.bytes),me=class{constructor(e,t,r,s){this.code=e,this.size=t,this.digest=r,this.bytes=s}};var xt={};P(xt,{base58btc:()=>D,base58flickr:()=>yo});function lo(n,e){if(n.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),r=0;r<t.length;r++)t[r]=255;for(var s=0;s<n.length;s++){var i=n.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=n.length,c=n.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var d=0,w=0,x=0,T=f.length;x!==T&&f[x]===0;)x++,d++;for(var R=(T-x)*l+1>>>0,O=new Uint8Array(R);x!==T;){for(var q=f[x],j=0,F=R-1;(q!==0||j<w)&&F!==-1;F--,j++)q+=256*O[F]>>>0,O[F]=q%a>>>0,q=q/a>>>0;if(q!==0)throw new Error("Non-zero carry");w=j,x++}for(var U=R-w;U!==R&&O[U]===0;)U++;for(var ge=c.repeat(d);U<R;++U)ge+=n.charAt(O[U]);return ge}function g(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var d=0;if(f[d]!==" "){for(var w=0,x=0;f[d]===c;)w++,d++;for(var T=(f.length-d)*u+1>>>0,R=new Uint8Array(T);f[d];){var O=t[f.charCodeAt(d)];if(O===255)return;for(var q=0,j=T-1;(O!==0||q<x)&&j!==-1;j--,q++)O+=a*R[j]>>>0,R[j]=O%256>>>0,O=O/256>>>0;if(O!==0)throw new Error("Non-zero carry");x=q,d++}if(f[d]!==" "){for(var F=T-x;F!==T&&R[F]===0;)F++;for(var U=new Uint8Array(w+(T-F)),ge=w;F!==T;)U[ge++]=R[F++];return U}}}function B(f){var d=g(f);if(d)return d;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:g,decode:B}}var ho=lo,fo=ho,zr=fo;var vt=class{constructor(e,t,r){this.name=e,this.prefix=t,this.baseEncode=r}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},kt=class{constructor(e,t,r){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=r}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return Ir(this,e)}},Et=class{constructor(e){this.decoders=e}or(e){return Ir(this,e)}decode(e){let t=e[0],r=this.decoders[t];if(r)return r.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}},Ir=(n,e)=>new Et({...n.decoders||{[n.prefix]:n},...e.decoders||{[e.prefix]:e}}),Ct=class{constructor(e,t,r,s){this.name=e,this.prefix=t,this.baseEncode=r,this.baseDecode=s,this.encoder=new vt(e,t,r),this.decoder=new kt(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}},we=({name:n,prefix:e,encode:t,decode:r})=>new Ct(n,e,t,r),re=({prefix:n,name:e,alphabet:t})=>{let{encode:r,decode:s}=zr(t,e);return we({prefix:n,name:e,encode:r,decode:i=>Y(s(i))})},po=(n,e,t,r)=>{let s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=n.length;for(;n[i-1]==="=";)--i;let o=new Uint8Array(i*t/8|0),a=0,c=0,u=0;for(let l=0;l<i;++l){let h=s[n[l]];if(h===void 0)throw new SyntaxError(`Non-${r} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},go=(n,e,t)=>{let r=e[e.length-1]==="=",s=(1<<t)-1,i="",o=0,a=0;for(let c=0;c<n.length;++c)for(a=a<<8|n[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),r)for(;i.length*t&7;)i+="=";return i},C=({name:n,prefix:e,bitsPerChar:t,alphabet:r})=>we({prefix:e,name:n,encode(s){return go(s,r,t)},decode(s){return po(s,r,t,n)}});var D=re({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),yo=re({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var St={};P(St,{base32:()=>De,base32hex:()=>Do,base32hexpad:()=>vo,base32hexpadupper:()=>ko,base32hexupper:()=>_o,base32pad:()=>mo,base32padupper:()=>wo,base32upper:()=>bo,base32z:()=>Eo});var De=C({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),bo=C({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),mo=C({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),wo=C({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),Do=C({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),_o=C({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),vo=C({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),ko=C({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),Eo=C({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var _=class{constructor(e,t,r,s){this.code=t,this.version=e,this.multihash=r,this.bytes=s,this.byteOffset=s.byteOffset,this.byteLength=s.byteLength,this.asCID=this,this._baseCache=new Map,Object.defineProperties(this,{byteOffset:Ge,byteLength:Ge,code:$e,version:$e,multihash:$e,bytes:$e,_baseCache:Ge,asCID:Ge})}toV0(){switch(this.version){case 0:return this;default:{let{code:e,multihash:t}=this;if(e!==Te)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==Bo)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return _.createV0(t)}}}toV1(){switch(this.version){case 0:{let{code:e,digest:t}=this.multihash,r=ce(e,t);return _.createV1(this.code,r)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}equals(e){return e&&this.code===e.code&&this.version===e.version&&Nr(this.multihash,e.multihash)}toString(e){let{bytes:t,version:r,_baseCache:s}=this;switch(r){case 0:return xo(t,s,e||D.encoder);default:return So(t,s,e||De.encoder)}}toJSON(){return{code:this.code,version:this.version,hash:this.multihash.bytes}}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return"CID("+this.toString()+")"}static isCID(e){return To(/^0\.0/,Oo),!!(e&&(e[jr]||e.asCID===e))}get toBaseEncodedString(){throw new Error("Deprecated, use .toString()")}get codec(){throw new Error('"codec" property is deprecated, use integer "code" property instead')}get buffer(){throw new Error("Deprecated .buffer property, use .bytes to get Uint8Array instead")}get multibaseName(){throw new Error('"multibaseName" property is deprecated')}get prefix(){throw new Error('"prefix" property is deprecated')}static asCID(e){if(e instanceof _)return e;if(e!=null&&e.asCID===e){let{version:t,code:r,multihash:s,bytes:i}=e;return new _(t,r,s,i||Rr(t,r,s.bytes))}else if(e!=null&&e[jr]===!0){let{version:t,multihash:r,code:s}=e,i=Pr(r);return _.create(t,s,i)}else return null}static create(e,t,r){if(typeof t!="number")throw new Error("String codecs are no longer supported");switch(e){case 0:{if(t!==Te)throw new Error(`Version 0 CID must use dag-pb (code: ${Te}) block encoding`);return new _(e,t,r,r.bytes)}case 1:{let s=Rr(e,t,r.bytes);return new _(e,t,r,s)}default:throw new Error("Invalid version")}}static createV0(e){return _.create(0,Te,e)}static createV1(e,t){return _.create(1,e,t)}static decode(e){let[t,r]=_.decodeFirst(e);if(r.length)throw new Error("Incorrect length");return t}static decodeFirst(e){let t=_.inspectBytes(e),r=t.size-t.multihashSize,s=Y(e.subarray(r,r+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");let i=s.subarray(t.multihashSize-t.digestSize),o=new me(t.multihashCode,t.digestSize,i,s);return[t.version===0?_.createV0(o):_.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0,r=()=>{let[h,g]=Be(e.subarray(t));return t+=g,h},s=r(),i=Te;if(s===18?(s=0,t=0):s===1&&(i=r()),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);let o=t,a=r(),c=r(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){let[r,s]=Co(e,t),i=_.decode(s);return i._baseCache.set(r,e),i}},Co=(n,e)=>{switch(n[0]){case"Q":{let t=e||D;return[D.prefix,t.decode(`${D.prefix}${n}`)]}case D.prefix:{let t=e||D;return[D.prefix,t.decode(n)]}case De.prefix:{let t=e||De;return[De.prefix,t.decode(n)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[n[0],e.decode(n)]}}},xo=(n,e,t)=>{let{prefix:r}=t;if(r!==D.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);let s=e.get(r);if(s==null){let i=t.encode(n).slice(1);return e.set(r,i),i}else return s},So=(n,e,t)=>{let{prefix:r}=t,s=e.get(r);if(s==null){let i=t.encode(n);return e.set(r,i),i}else return s},Te=112,Bo=18,Rr=(n,e,t)=>{let r=be(n),s=r+be(e),i=new Uint8Array(s+t.byteLength);return ye(n,i,0),ye(e,i,r),i.set(t,s),i},jr=Symbol.for("@ipld/js-cid/CID"),$e={writable:!1,configurable:!1,enumerable:!0},Ge={writable:!1,enumerable:!1,configurable:!1},Ao="0.0.0-dev",To=(n,e)=>{if(n.test(Ao))console.warn(e);else throw new Error(e)},Oo=`CID.isCID(v) is deprecated and will be removed in the next major release.
Following code pattern:

if (CID.isCID(value)) {
  doSomethingWithCID(value)
}

Is replaced with:

const cid = CID.asCID(value)
if (cid) {
  // Make sure to use cid instead of value
  doSomethingWithCID(cid)
}
`;var Tt={};P(Tt,{sha256:()=>Oe,sha512:()=>Mo});var At=({name:n,code:e,encode:t})=>new Bt(n,e,t),Bt=class{constructor(e,t,r){this.name=e,this.code=t,this.encode=r}digest(e){if(e instanceof Uint8Array){let t=this.encode(e);return t instanceof Uint8Array?ce(this.code,t):t.then(r=>ce(this.code,r))}else throw Error("Unknown type, must be binary type")}};var Wr=n=>async e=>new Uint8Array(await crypto.subtle.digest(n,e)),Oe=At({name:"sha2-256",code:18,encode:Wr("SHA-256")}),Mo=At({name:"sha2-512",code:19,encode:Wr("SHA-512")});var Ds=M(rn(),1);var Me=M(pn(),1);function ia(n){let e=new Uint8Array(n.reduce((r,s)=>r+Me.default.encodingLength(s),0)),t=0;for(let r of n)e=Me.encode(r,e,t),t+=Me.default.encodingLength(r);return e}var dn=ia;var Jt=M(wn(),1);function Ke(n,e){if(n===e)return!0;if(n.byteLength!==e.byteLength)return!1;for(let t=0;t<n.byteLength;t++)if(n[t]!==e[t])return!1;return!0}var Le=class{constructor(e,t,r){this._refCounter=1,this.cid=e,this.priority=t||1,this.wantType=r}inc(){this._refCounter+=1}dec(){this._refCounter=Math.max(0,this._refCounter-1)}hasRefs(){return this._refCounter>0}get[Symbol.toStringTag](){return`WantlistEntry <key: ${this.cid.toString(D)}, priority: ${this.priority}, refs: ${this._refCounter}>`}equals(e){return this._refCounter===e._refCounter&&this.cid.equals(e.cid)&&this.priority===e.priority&&this.wantType===e.wantType}};var G=M(ys(),1),X=G.default.Reader,ze=G.default.Writer,v=G.default.util,b=G.default.roots["ipfs-bitswap"]||(G.default.roots["ipfs-bitswap"]={}),z=b.Message=(()=>{function n(e){if(this.blocks=[],this.payload=[],this.blockPresences=[],e)for(var t=Object.keys(e),r=0;r<t.length;++r)e[t[r]]!=null&&(this[t[r]]=e[t[r]])}return n.prototype.wantlist=null,n.prototype.blocks=v.emptyArray,n.prototype.payload=v.emptyArray,n.prototype.blockPresences=v.emptyArray,n.prototype.pendingBytes=0,n.encode=function(t,r){if(r||(r=ze.create()),t.wantlist!=null&&Object.hasOwnProperty.call(t,"wantlist")&&b.Message.Wantlist.encode(t.wantlist,r.uint32(10).fork()).ldelim(),t.blocks!=null&&t.blocks.length)for(var s=0;s<t.blocks.length;++s)r.uint32(18).bytes(t.blocks[s]);if(t.payload!=null&&t.payload.length)for(var s=0;s<t.payload.length;++s)b.Message.Block.encode(t.payload[s],r.uint32(26).fork()).ldelim();if(t.blockPresences!=null&&t.blockPresences.length)for(var s=0;s<t.blockPresences.length;++s)b.Message.BlockPresence.encode(t.blockPresences[s],r.uint32(34).fork()).ldelim();return t.pendingBytes!=null&&Object.hasOwnProperty.call(t,"pendingBytes")&&r.uint32(40).int32(t.pendingBytes),r},n.decode=function(t,r){t instanceof X||(t=X.create(t));for(var s=r===void 0?t.len:t.pos+r,i=new b.Message;t.pos<s;){var o=t.uint32();switch(o>>>3){case 1:{i.wantlist=b.Message.Wantlist.decode(t,t.uint32());break}case 2:{i.blocks&&i.blocks.length||(i.blocks=[]),i.blocks.push(t.bytes());break}case 3:{i.payload&&i.payload.length||(i.payload=[]),i.payload.push(b.Message.Block.decode(t,t.uint32()));break}case 4:{i.blockPresences&&i.blockPresences.length||(i.blockPresences=[]),i.blockPresences.push(b.Message.BlockPresence.decode(t,t.uint32()));break}case 5:{i.pendingBytes=t.int32();break}default:t.skipType(o&7);break}}return i},n.fromObject=function(t){if(t instanceof b.Message)return t;var r=new b.Message;if(t.wantlist!=null){if(typeof t.wantlist!="object")throw TypeError(".Message.wantlist: object expected");r.wantlist=b.Message.Wantlist.fromObject(t.wantlist)}if(t.blocks){if(!Array.isArray(t.blocks))throw TypeError(".Message.blocks: array expected");r.blocks=[];for(var s=0;s<t.blocks.length;++s)typeof t.blocks[s]=="string"?v.base64.decode(t.blocks[s],r.blocks[s]=v.newBuffer(v.base64.length(t.blocks[s])),0):t.blocks[s].length>=0&&(r.blocks[s]=t.blocks[s])}if(t.payload){if(!Array.isArray(t.payload))throw TypeError(".Message.payload: array expected");r.payload=[];for(var s=0;s<t.payload.length;++s){if(typeof t.payload[s]!="object")throw TypeError(".Message.payload: object expected");r.payload[s]=b.Message.Block.fromObject(t.payload[s])}}if(t.blockPresences){if(!Array.isArray(t.blockPresences))throw TypeError(".Message.blockPresences: array expected");r.blockPresences=[];for(var s=0;s<t.blockPresences.length;++s){if(typeof t.blockPresences[s]!="object")throw TypeError(".Message.blockPresences: object expected");r.blockPresences[s]=b.Message.BlockPresence.fromObject(t.blockPresences[s])}}return t.pendingBytes!=null&&(r.pendingBytes=t.pendingBytes|0),r},n.toObject=function(t,r){r||(r={});var s={};if((r.arrays||r.defaults)&&(s.blocks=[],s.payload=[],s.blockPresences=[]),r.defaults&&(s.wantlist=null,s.pendingBytes=0),t.wantlist!=null&&t.hasOwnProperty("wantlist")&&(s.wantlist=b.Message.Wantlist.toObject(t.wantlist,r)),t.blocks&&t.blocks.length){s.blocks=[];for(var i=0;i<t.blocks.length;++i)s.blocks[i]=r.bytes===String?v.base64.encode(t.blocks[i],0,t.blocks[i].length):r.bytes===Array?Array.prototype.slice.call(t.blocks[i]):t.blocks[i]}if(t.payload&&t.payload.length){s.payload=[];for(var i=0;i<t.payload.length;++i)s.payload[i]=b.Message.Block.toObject(t.payload[i],r)}if(t.blockPresences&&t.blockPresences.length){s.blockPresences=[];for(var i=0;i<t.blockPresences.length;++i)s.blockPresences[i]=b.Message.BlockPresence.toObject(t.blockPresences[i],r)}return t.pendingBytes!=null&&t.hasOwnProperty("pendingBytes")&&(s.pendingBytes=t.pendingBytes),s},n.prototype.toJSON=function(){return this.constructor.toObject(this,G.default.util.toJSONOptions)},n.getTypeUrl=function(t){return t===void 0&&(t="type.googleapis.com"),t+"/Message"},n.Wantlist=function(){function e(t){if(this.entries=[],t)for(var r=Object.keys(t),s=0;s<r.length;++s)t[r[s]]!=null&&(this[r[s]]=t[r[s]])}return e.prototype.entries=v.emptyArray,e.prototype.full=!1,e.encode=function(r,s){if(s||(s=ze.create()),r.entries!=null&&r.entries.length)for(var i=0;i<r.entries.length;++i)b.Message.Wantlist.Entry.encode(r.entries[i],s.uint32(10).fork()).ldelim();return r.full!=null&&Object.hasOwnProperty.call(r,"full")&&s.uint32(16).bool(r.full),s},e.decode=function(r,s){r instanceof X||(r=X.create(r));for(var i=s===void 0?r.len:r.pos+s,o=new b.Message.Wantlist;r.pos<i;){var a=r.uint32();switch(a>>>3){case 1:{o.entries&&o.entries.length||(o.entries=[]),o.entries.push(b.Message.Wantlist.Entry.decode(r,r.uint32()));break}case 2:{o.full=r.bool();break}default:r.skipType(a&7);break}}return o},e.fromObject=function(r){if(r instanceof b.Message.Wantlist)return r;var s=new b.Message.Wantlist;if(r.entries){if(!Array.isArray(r.entries))throw TypeError(".Message.Wantlist.entries: array expected");s.entries=[];for(var i=0;i<r.entries.length;++i){if(typeof r.entries[i]!="object")throw TypeError(".Message.Wantlist.entries: object expected");s.entries[i]=b.Message.Wantlist.Entry.fromObject(r.entries[i])}}return r.full!=null&&(s.full=Boolean(r.full)),s},e.toObject=function(r,s){s||(s={});var i={};if((s.arrays||s.defaults)&&(i.entries=[]),s.defaults&&(i.full=!1),r.entries&&r.entries.length){i.entries=[];for(var o=0;o<r.entries.length;++o)i.entries[o]=b.Message.Wantlist.Entry.toObject(r.entries[o],s)}return r.full!=null&&r.hasOwnProperty("full")&&(i.full=r.full),i},e.prototype.toJSON=function(){return this.constructor.toObject(this,G.default.util.toJSONOptions)},e.getTypeUrl=function(r){return r===void 0&&(r="type.googleapis.com"),r+"/Message.Wantlist"},e.WantType=function(){let t={},r=Object.create(t);return r[t[0]="Block"]=0,r[t[1]="Have"]=1,r}(),e.Entry=function(){function t(r){if(r)for(var s=Object.keys(r),i=0;i<s.length;++i)r[s[i]]!=null&&(this[s[i]]=r[s[i]])}return t.prototype.block=v.newBuffer([]),t.prototype.priority=0,t.prototype.cancel=!1,t.prototype.wantType=0,t.prototype.sendDontHave=!1,t.encode=function(s,i){return i||(i=ze.create()),s.block!=null&&Object.hasOwnProperty.call(s,"block")&&i.uint32(10).bytes(s.block),s.priority!=null&&Object.hasOwnProperty.call(s,"priority")&&i.uint32(16).int32(s.priority),s.cancel!=null&&Object.hasOwnProperty.call(s,"cancel")&&i.uint32(24).bool(s.cancel),s.wantType!=null&&Object.hasOwnProperty.call(s,"wantType")&&i.uint32(32).int32(s.wantType),s.sendDontHave!=null&&Object.hasOwnProperty.call(s,"sendDontHave")&&i.uint32(40).bool(s.sendDontHave),i},t.decode=function(s,i){s instanceof X||(s=X.create(s));for(var o=i===void 0?s.len:s.pos+i,a=new b.Message.Wantlist.Entry;s.pos<o;){var c=s.uint32();switch(c>>>3){case 1:{a.block=s.bytes();break}case 2:{a.priority=s.int32();break}case 3:{a.cancel=s.bool();break}case 4:{a.wantType=s.int32();break}case 5:{a.sendDontHave=s.bool();break}default:s.skipType(c&7);break}}return a},t.fromObject=function(s){if(s instanceof b.Message.Wantlist.Entry)return s;var i=new b.Message.Wantlist.Entry;switch(s.block!=null&&(typeof s.block=="string"?v.base64.decode(s.block,i.block=v.newBuffer(v.base64.length(s.block)),0):s.block.length>=0&&(i.block=s.block)),s.priority!=null&&(i.priority=s.priority|0),s.cancel!=null&&(i.cancel=Boolean(s.cancel)),s.wantType){case"Block":case 0:i.wantType=0;break;case"Have":case 1:i.wantType=1;break}return s.sendDontHave!=null&&(i.sendDontHave=Boolean(s.sendDontHave)),i},t.toObject=function(s,i){i||(i={});var o={};return i.defaults&&(i.bytes===String?o.block="":(o.block=[],i.bytes!==Array&&(o.block=v.newBuffer(o.block))),o.priority=0,o.cancel=!1,o.wantType=i.enums===String?"Block":0,o.sendDontHave=!1),s.block!=null&&s.hasOwnProperty("block")&&(o.block=i.bytes===String?v.base64.encode(s.block,0,s.block.length):i.bytes===Array?Array.prototype.slice.call(s.block):s.block),s.priority!=null&&s.hasOwnProperty("priority")&&(o.priority=s.priority),s.cancel!=null&&s.hasOwnProperty("cancel")&&(o.cancel=s.cancel),s.wantType!=null&&s.hasOwnProperty("wantType")&&(o.wantType=i.enums===String?b.Message.Wantlist.WantType[s.wantType]:s.wantType),s.sendDontHave!=null&&s.hasOwnProperty("sendDontHave")&&(o.sendDontHave=s.sendDontHave),o},t.prototype.toJSON=function(){return this.constructor.toObject(this,G.default.util.toJSONOptions)},t.getTypeUrl=function(s){return s===void 0&&(s="type.googleapis.com"),s+"/Message.Wantlist.Entry"},t}(),e}(),n.Block=function(){function e(t){if(t)for(var r=Object.keys(t),s=0;s<r.length;++s)t[r[s]]!=null&&(this[r[s]]=t[r[s]])}return e.prototype.prefix=v.newBuffer([]),e.prototype.data=v.newBuffer([]),e.encode=function(r,s){return s||(s=ze.create()),r.prefix!=null&&Object.hasOwnProperty.call(r,"prefix")&&s.uint32(10).bytes(r.prefix),r.data!=null&&Object.hasOwnProperty.call(r,"data")&&s.uint32(18).bytes(r.data),s},e.decode=function(r,s){r instanceof X||(r=X.create(r));for(var i=s===void 0?r.len:r.pos+s,o=new b.Message.Block;r.pos<i;){var a=r.uint32();switch(a>>>3){case 1:{o.prefix=r.bytes();break}case 2:{o.data=r.bytes();break}default:r.skipType(a&7);break}}return o},e.fromObject=function(r){if(r instanceof b.Message.Block)return r;var s=new b.Message.Block;return r.prefix!=null&&(typeof r.prefix=="string"?v.base64.decode(r.prefix,s.prefix=v.newBuffer(v.base64.length(r.prefix)),0):r.prefix.length>=0&&(s.prefix=r.prefix)),r.data!=null&&(typeof r.data=="string"?v.base64.decode(r.data,s.data=v.newBuffer(v.base64.length(r.data)),0):r.data.length>=0&&(s.data=r.data)),s},e.toObject=function(r,s){s||(s={});var i={};return s.defaults&&(s.bytes===String?i.prefix="":(i.prefix=[],s.bytes!==Array&&(i.prefix=v.newBuffer(i.prefix))),s.bytes===String?i.data="":(i.data=[],s.bytes!==Array&&(i.data=v.newBuffer(i.data)))),r.prefix!=null&&r.hasOwnProperty("prefix")&&(i.prefix=s.bytes===String?v.base64.encode(r.prefix,0,r.prefix.length):s.bytes===Array?Array.prototype.slice.call(r.prefix):r.prefix),r.data!=null&&r.hasOwnProperty("data")&&(i.data=s.bytes===String?v.base64.encode(r.data,0,r.data.length):s.bytes===Array?Array.prototype.slice.call(r.data):r.data),i},e.prototype.toJSON=function(){return this.constructor.toObject(this,G.default.util.toJSONOptions)},e.getTypeUrl=function(r){return r===void 0&&(r="type.googleapis.com"),r+"/Message.Block"},e}(),n.BlockPresenceType=function(){let e={},t=Object.create(e);return t[e[0]="Have"]=0,t[e[1]="DontHave"]=1,t}(),n.BlockPresence=function(){function e(t){if(t)for(var r=Object.keys(t),s=0;s<r.length;++s)t[r[s]]!=null&&(this[r[s]]=t[r[s]])}return e.prototype.cid=v.newBuffer([]),e.prototype.type=0,e.encode=function(r,s){return s||(s=ze.create()),r.cid!=null&&Object.hasOwnProperty.call(r,"cid")&&s.uint32(10).bytes(r.cid),r.type!=null&&Object.hasOwnProperty.call(r,"type")&&s.uint32(16).int32(r.type),s},e.decode=function(r,s){r instanceof X||(r=X.create(r));for(var i=s===void 0?r.len:r.pos+s,o=new b.Message.BlockPresence;r.pos<i;){var a=r.uint32();switch(a>>>3){case 1:{o.cid=r.bytes();break}case 2:{o.type=r.int32();break}default:r.skipType(a&7);break}}return o},e.fromObject=function(r){if(r instanceof b.Message.BlockPresence)return r;var s=new b.Message.BlockPresence;switch(r.cid!=null&&(typeof r.cid=="string"?v.base64.decode(r.cid,s.cid=v.newBuffer(v.base64.length(r.cid)),0):r.cid.length>=0&&(s.cid=r.cid)),r.type){case"Have":case 0:s.type=0;break;case"DontHave":case 1:s.type=1;break}return s},e.toObject=function(r,s){s||(s={});var i={};return s.defaults&&(s.bytes===String?i.cid="":(i.cid=[],s.bytes!==Array&&(i.cid=v.newBuffer(i.cid))),i.type=s.enums===String?"Have":0),r.cid!=null&&r.hasOwnProperty("cid")&&(i.cid=s.bytes===String?v.base64.encode(r.cid,0,r.cid.length):s.bytes===Array?Array.prototype.slice.call(r.cid):r.cid),r.type!=null&&r.hasOwnProperty("type")&&(i.type=s.enums===String?b.Message.BlockPresenceType[r.type]:r.type),i},e.prototype.toJSON=function(){return this.constructor.toObject(this,G.default.util.toJSONOptions)},e.getTypeUrl=function(r){return r===void 0&&(r="type.googleapis.com"),r+"/Message.BlockPresence"},e}(),n})();var Gt=class extends Map{constructor(e){super();let{system:t,component:r,metric:s,metrics:i}=e;this.system=t??"libp2p",this.component=r,this.metric=s,this.metrics=i,this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){let t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metrics.updateComponentMetric({system:this.system,component:this.component,metric:this.metric,value:this.size})}};function oe(n){let{system:e,component:t,metric:r,metrics:s}=n,i;return s!=null?i=new Gt({system:e,component:t,metric:r,metrics:s}):i=new Map,i}var bs={Block:z.Wantlist.WantType.Block,Have:z.Wantlist.WantType.Have},Sa=(n,e)=>Array.prototype.slice.call(e,0).sort((t,r)=>{let s=n(t),i=n(r);return s<i?-1:s>i?1:0}),J=class{constructor(e,t){this.set=t?oe({system:"ipfs",component:"bitswap",metric:"wantlist",metrics:t.metrics}):new Map,this._stats=e}get length(){return this.set.size}add(e,t,r){let s=e.toString(D),i=this.set.get(s);i?(i.inc(),i.priority=t,i.wantType===bs.Have&&r===bs.Block&&(i.wantType=r)):(this.set.set(s,new Le(e,t,r)),this._stats&&this._stats.push(null,"wantListSize",1))}remove(e){let t=e.toString(D),r=this.set.get(t);!r||(r.dec(),!r.hasRefs()&&(this.set.delete(t),this._stats&&this._stats.push(null,"wantListSize",-1)))}removeForce(e){this.set.has(e)&&this.set.delete(e)}forEach(e){return this.set.forEach(e)}entries(){return this.set.entries()}sortedEntries(){return new Map(Sa(e=>e[1].key,Array.from(this.set.entries())))}contains(e){let t=e.toString(D);return this.set.has(t)}get(e){let t=e.toString(D);return this.set.get(t)}};J.Entry=Le;var Ba=J.Entry,ae=class{constructor(e,t,r,s,i){this.entry=new Ba(e,t,r),this.cancel=Boolean(s),this.sendDontHave=Boolean(i)}get cid(){return this.entry.cid}set cid(e){this.entry.cid=e}get priority(){return this.entry.priority}set priority(e){this.entry.priority=e}get wantType(){return this.entry.wantType}set wantType(e){this.entry.wantType=e}get[Symbol.toStringTag](){return`BitswapMessageEntry ${this.cid.toString(D)} <cancel: ${this.cancel}, priority: ${this.priority}>`}equals(e){return this.cancel===e.cancel&&this.sendDontHave===e.sendDontHave&&this.wantType===e.wantType&&this.entry.equals(e.entry)}};var H=(n,e)=>{let t=["bitswap"];return e&&t.push(e),n&&t.push(`${n.toString().slice(0,8)}`),Object.assign((0,Jt.default)(t.join(":")),{error:(0,Jt.default)(t.concat(["error"]).join(":"))})};var tt=(n,e)=>{if(n.size!==e.size)return!1;for(let[t,r]of n){let s=e.get(t);if(s===void 0||r instanceof Uint8Array&&s instanceof Uint8Array&&!Ke(r,s)||r instanceof ae&&s instanceof ae&&!r.equals(s))return!1}return!0};var _s=M(Qt(),1),k=class{constructor(e){this.full=e,this.wantlist=new Map,this.blocks=new Map,this.blockPresences=new Map,this.pendingBytes=0}get empty(){return this.blocks.size===0&&this.wantlist.size===0&&this.blockPresences.size===0}addEntry(e,t,r,s,i){r==null&&(r=k.WantType.Block);let o=e.toString(D),a=this.wantlist.get(o);a?(a.wantType===r&&(a.priority=t),s&&(a.cancel=Boolean(s)),i&&(a.sendDontHave=Boolean(i)),r===k.WantType.Block&&a.wantType===k.WantType.Have&&(a.wantType=r)):this.wantlist.set(o,new ae(e,t,r,s,i))}addBlock(e,t){let r=e.toString(D);this.blocks.set(r,t)}addHave(e){let t=e.toString(D);this.blockPresences.has(t)||this.blockPresences.set(t,k.BlockPresenceType.Have)}addDontHave(e){let t=e.toString(D);this.blockPresences.has(t)||this.blockPresences.set(t,k.BlockPresenceType.DontHave)}cancel(e){let t=e.toString(D);this.wantlist.delete(t),this.addEntry(e,0,k.WantType.Block,!0,!1)}setPendingBytes(e){this.pendingBytes=e}serializeToBitswap100(){let e={wantlist:{entries:Array.from(this.wantlist.values()).map(t=>({block:t.cid.bytes,priority:Number(t.priority),cancel:Boolean(t.cancel)})),full:this.full?!0:void 0},blocks:Array.from(this.blocks.values())};return z.encode(e).finish()}serializeToBitswap110(){let e={wantlist:{entries:Array.from(this.wantlist.values()).map(t=>({block:t.cid.bytes,priority:Number(t.priority),wantType:t.wantType,cancel:Boolean(t.cancel),sendDontHave:Boolean(t.sendDontHave)})),full:this.full?!0:void 0},blockPresences:[],payload:[],pendingBytes:this.pendingBytes};for(let[t,r]of this.blocks.entries()){let s=_.parse(t),i=s.version,o=s.code,a=s.multihash.code,c=s.multihash.digest.length,u=dn([i,o,a,c]);e.payload.push(new z.Block({prefix:u,data:r}))}for(let[t,r]of this.blockPresences)e.blockPresences.push(new z.BlockPresence({cid:_.parse(t).bytes,type:r}));return this.pendingBytes>0&&(e.pendingBytes=this.pendingBytes),z.encode(e).finish()}equals(e){return!(this.full!==e.full||this.pendingBytes!==e.pendingBytes||!tt(this.wantlist,e.wantlist)||!tt(this.blocks,e.blocks)||!tt(this.blockPresences,e.blockPresences))}get[Symbol.toStringTag](){let e=Array.from(this.wantlist.keys()),t=Array.from(this.blocks.keys());return`BitswapMessage <full: ${this.full}, list: ${e}, blocks: ${t}>`}};k.deserialize=async(n,e)=>{let t=z.decode(n),r=t.wantlist&&t.wantlist.full||!1,s=new k(r);return t.wantlist&&t.wantlist.entries&&t.wantlist.entries.forEach(i=>{if(!i.block)return;let o=_.decode(i.block);s.addEntry(o,i.priority||0,i.wantType,Boolean(i.cancel),Boolean(i.sendDontHave))}),t.blockPresences&&t.blockPresences.forEach(i=>{if(!i.cid)return;let o=_.decode(i.cid);i.type===k.BlockPresenceType.Have?s.addHave(o):s.addDontHave(o)}),t.blocks.length>0?(await Promise.all(t.blocks.map(async i=>{let o=await Oe.digest(i),a=_.createV0(o);s.addBlock(a,i)})),s):(t.payload.length>0&&(await Promise.all(t.payload.map(async i=>{if(!i.prefix||!i.data)return;let o=(0,Ds.default)(i.prefix),a=o[0],c=o[1],u=o[2],l=u===Oe.code?Oe:e&&await e.getHasher(u);if(!l)throw(0,_s.default)(new Error("Unknown hash algorithm"),"ERR_UNKNOWN_HASH_ALG");let h=await l.digest(i.data),g=_.create(a,c,h);s.addBlock(g,i.data)})),s.setPendingBytes(t.pendingBytes)),s)};k.blockPresenceSize=n=>n.bytes.length+1;k.Entry=ae;k.WantType={Block:z.Wantlist.WantType.Block,Have:z.Wantlist.WantType.Have};k.BlockPresenceType={Have:z.BlockPresenceType.Have,DontHave:z.BlockPresenceType.DontHave};var vs=Math.pow(2,31)-1,ks=1e3,Es=1;var Cs=Ta;function Ta(n,e,t){var r=null,s=null,i=function(){r&&(clearTimeout(r),s=null,r=null)},o=function(){var c=s;i(),c&&c()},a=function(){if(!e)return n.apply(this,arguments);var c=this,u=arguments,l=t&&!r;if(i(),s=function(){n.apply(c,u)},r=setTimeout(function(){if(r=null,!l){var h=s;return s=null,h()}},e),l)return s()};return a.cancel=i,a.flush=o,a}var rt=class{constructor(e,t,r){this.peerId=t,this.network=r,this.refcnt=1,this._entries=[],this._log=H(e,"msgqueue"),this.sendEntries=Cs(this._sendEntries.bind(this),Es)}addMessage(e){e.empty||this.send(e)}addEntries(e){this._entries=this._entries.concat(e),this.sendEntries()}_sendEntries(){if(!this._entries.length)return;let e=new k(!1);this._entries.forEach(t=>{t.cancel?e.cancel(t.cid):e.addEntry(t.cid,t.priority)}),this._entries=[],this.addMessage(e)}async send(e){try{await this.network.connectTo(this.peerId)}catch(t){this._log.error("cant connect to peer %s: %s",this.peerId.toString(),t.message);return}this._log("sending message to peer %s",this.peerId.toString()),this.network.sendMessage(this.peerId,e).catch(t=>{this._log.error("send error: %s",t.message)})}};var nt=class{constructor(e,t,r,s){this.peers=oe({system:"ipfs",component:"bitswap",metric:"want-manager-peers",metrics:s.metrics}),this.wantlist=new J(r,s),this.network=t,this._stats=r,this._peerId=e,this._log=H(e,"want")}_addEntries(e,t,r){let s=e.map((i,o)=>new k.Entry(i,vs-o,k.WantType.Block,t));s.forEach(i=>{i.cancel?r?this.wantlist.removeForce(i.cid.toString(D)):this.wantlist.remove(i.cid):(this._log("adding to wl"),this.wantlist.add(i.cid,i.priority))});for(let i of this.peers.values())i.addEntries(s)}_startPeerHandler(e){let t=this.peers.get(e.toString());if(t){t.refcnt++;return}t=new rt(this._peerId,e,this.network);let r=new k(!0);for(let s of this.wantlist.entries())r.addEntry(s[1].cid,s[1].priority);return t.addMessage(r),this.peers.set(e.toString(),t),t}_stopPeerHandler(e){let t=this.peers.get(e.toString());!t||(t.refcnt--,!(t.refcnt>0)&&this.peers.delete(e.toString()))}wantBlocks(e,t={}){this._addEntries(e,!1),t&&t.signal&&t.signal.addEventListener("abort",()=>{this.cancelWants(e)})}unwantBlocks(e){this._log("unwant blocks: %s",e.length),this._addEntries(e,!0,!0)}cancelWants(e){this._log("cancel wants: %s",e.length),this._addEntries(e,!0)}connectedPeers(){return Array.from(this.peers.keys())}connected(e){this._startPeerHandler(e)}disconnected(e){this._stopPeerHandler(e)}start(){}stop(){this.peers.forEach(e=>this.disconnected(e.peerId))}};function ee(n=0){return globalThis.Buffer!=null&&globalThis.Buffer.alloc!=null?globalThis.Buffer.alloc(n):new Uint8Array(n)}function te(n=0){return globalThis.Buffer!=null&&globalThis.Buffer.allocUnsafe!=null?globalThis.Buffer.allocUnsafe(n):new Uint8Array(n)}function Xt(n,e){e||(e=n.reduce((s,i)=>s+i.length,0));let t=te(e),r=0;for(let s of n)t.set(s,r),r+=s.length;return t}var Ss=Symbol.for("@achingbrain/uint8arraylist");function xs(n,e){if(e==null||e<0)throw new RangeError("index is out of bounds");let t=0;for(let r of n){let s=t+r.byteLength;if(e<s)return{buf:r,index:e-t};t=s}throw new RangeError("index is out of bounds")}function Zt(n){return Boolean(n?.[Ss])}var Z=class{constructor(...e){Object.defineProperty(this,Ss,{value:!0}),this.bufs=[],this.length=0,e.length>0&&this.appendAll(e)}*[Symbol.iterator](){yield*this.bufs}get byteLength(){return this.length}append(...e){this.appendAll(e)}appendAll(e){let t=0;for(let r of e)if(r instanceof Uint8Array)t+=r.byteLength,this.bufs.push(r);else if(Zt(r))t+=r.byteLength,this.bufs.push(...r.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}prepend(...e){this.prependAll(e)}prependAll(e){let t=0;for(let r of e.reverse())if(r instanceof Uint8Array)t+=r.byteLength,this.bufs.unshift(r);else if(Zt(r))t+=r.byteLength,this.bufs.unshift(...r.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}get(e){let t=xs(this.bufs,e);return t.buf[t.index]}set(e,t){let r=xs(this.bufs,e);r.buf[r.index]=t}write(e,t=0){if(e instanceof Uint8Array)for(let r=0;r<e.length;r++)this.set(t+r,e[r]);else if(Zt(e))for(let r=0;r<e.length;r++)this.set(t+r,e.get(r));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(e){if(e=Math.trunc(e),!(Number.isNaN(e)||e<=0))for(;this.bufs.length>0;)if(e>=this.bufs[0].byteLength)e-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(e),this.length-=e;break}}slice(e,t){let{bufs:r,length:s}=this._subList(e,t);return Xt(r,s)}subarray(e,t){let{bufs:r,length:s}=this._subList(e,t);return r.length===1?r[0]:Xt(r,s)}sublist(e,t){let{bufs:r,length:s}=this._subList(e,t),i=new Z;return i.length=s,i.bufs=r,i}_subList(e,t){if(e=e??0,t=t??this.length,e<0&&(e=this.length+e),t<0&&(t=this.length+t),e<0||t>this.length)throw new RangeError("index is out of bounds");if(e===t)return{bufs:[],length:0};if(e===0&&t===this.length)return{bufs:[...this.bufs],length:this.length};let r=[],s=0;for(let i=0;i<this.bufs.length;i++){let o=this.bufs[i],a=s,c=a+o.byteLength;if(s=c,e>=c)continue;let u=e>=a&&e<c,l=t>a&&t<=c;if(u&&l){if(e===a&&t===c){r.push(o);break}let h=e-a;r.push(o.subarray(h,h+(t-e)));break}if(u){if(e===0){r.push(o);continue}r.push(o.subarray(e-a));continue}if(l){if(t===c){r.push(o);break}r.push(o.subarray(0,t-a));break}r.push(o)}return{bufs:r,length:t-e}}getInt8(e){let t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getInt8(0)}setInt8(e,t){let r=te(1);new DataView(r.buffer,r.byteOffset,r.byteLength).setInt8(0,t),this.write(r,e)}getInt16(e,t){let r=this.subarray(e,e+2);return new DataView(r.buffer,r.byteOffset,r.byteLength).getInt16(0,t)}setInt16(e,t,r){let s=ee(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt16(0,t,r),this.write(s,e)}getInt32(e,t){let r=this.subarray(e,e+4);return new DataView(r.buffer,r.byteOffset,r.byteLength).getInt32(0,t)}setInt32(e,t,r){let s=ee(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt32(0,t,r),this.write(s,e)}getBigInt64(e,t){let r=this.subarray(e,e+8);return new DataView(r.buffer,r.byteOffset,r.byteLength).getBigInt64(0,t)}setBigInt64(e,t,r){let s=ee(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigInt64(0,t,r),this.write(s,e)}getUint8(e){let t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint8(0)}setUint8(e,t){let r=te(1);new DataView(r.buffer,r.byteOffset,r.byteLength).setUint8(0,t),this.write(r,e)}getUint16(e,t){let r=this.subarray(e,e+2);return new DataView(r.buffer,r.byteOffset,r.byteLength).getUint16(0,t)}setUint16(e,t,r){let s=ee(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint16(0,t,r),this.write(s,e)}getUint32(e,t){let r=this.subarray(e,e+4);return new DataView(r.buffer,r.byteOffset,r.byteLength).getUint32(0,t)}setUint32(e,t,r){let s=ee(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint32(0,t,r),this.write(s,e)}getBigUint64(e,t){let r=this.subarray(e,e+8);return new DataView(r.buffer,r.byteOffset,r.byteLength).getBigUint64(0,t)}setBigUint64(e,t,r){let s=ee(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigUint64(0,t,r),this.write(s,e)}getFloat32(e,t){let r=this.subarray(e,e+4);return new DataView(r.buffer,r.byteOffset,r.byteLength).getFloat32(0,t)}setFloat32(e,t,r){let s=ee(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat32(0,t,r),this.write(s,e)}getFloat64(e,t){let r=this.subarray(e,e+8);return new DataView(r.buffer,r.byteOffset,r.byteLength).getFloat64(0,t)}setFloat64(e,t,r){let s=ee(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat64(0,t,r),this.write(s,e)}equals(e){if(e==null||!(e instanceof Z)||e.bufs.length!==this.bufs.length)return!1;for(let t=0;t<this.bufs.length;t++)if(!Ke(this.bufs[t],e.bufs[t]))return!1;return!0}static fromUint8Arrays(e,t){let r=new Z;return r.bufs=e,t==null&&(t=e.reduce((s,i)=>s+i.byteLength,0)),r.length=t,r}};function st(n){return n instanceof Uint8Array?{get(e){return n[e]},set(e,t){n[e]=t}}:{get(e){return n.get(e)},set(e,t){n.set(e,t)}}}var Bs=4294967296,I=class{constructor(e=0,t=0){this.hi=e,this.lo=t}toBigInt(e){if(e===!0)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31!==0){let t=~this.lo+1>>>0,r=~this.hi>>>0;return t===0&&(r=r+1>>>0),-(BigInt(t)+(BigInt(r)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toNumber(e){return Number(this.toBigInt(e))}zzDecode(){let e=-(this.lo&1),t=((this.lo>>>1|this.hi<<31)^e)>>>0,r=(this.hi>>>1^e)>>>0;return new I(r,t)}zzEncode(){let e=this.hi>>31,t=((this.hi<<1|this.lo>>>31)^e)>>>0,r=(this.lo<<1^e)>>>0;return new I(t,r)}toBytes(e,t=0){let r=st(e);for(;this.hi>0;)r.set(t++,this.lo&127|128),this.lo=(this.lo>>>7|this.hi<<25)>>>0,this.hi>>>=7;for(;this.lo>127;)r.set(t++,this.lo&127|128),this.lo=this.lo>>>7;r.set(t++,this.lo)}static fromBigInt(e){if(e===0n)return new I;let t=e<0;t&&(e=-e);let r=Number(e>>32n)|0,s=Number(e-(BigInt(r)<<32n))|0;return t&&(r=~r>>>0,s=~s>>>0,++s>Bs&&(s=0,++r>Bs&&(r=0))),new I(r,s)}static fromNumber(e){if(e===0)return new I;let t=e<0;t&&(e=-e);let r=e>>>0,s=(e-r)/4294967296>>>0;return t&&(s=~s>>>0,r=~r>>>0,++r>4294967295&&(r=0,++s>4294967295&&(s=0))),new I(s,r)}static fromBytes(e,t=0){let r=st(e),s=new I,i=0;if(e.length-t>4){for(;i<4;++i)if(s.lo=(s.lo|(r.get(t)&127)<<i*7)>>>0,r.get(t++)<128)return s;if(s.lo=(s.lo|(r.get(t)&127)<<28)>>>0,s.hi=(s.hi|(r.get(t)&127)>>4)>>>0,r.get(t++)<128)return s;i=0}else for(;i<4;++i){if(t>=e.length)throw RangeError(`index out of range: ${t} > ${e.length}`);if(s.lo=(s.lo|(r.get(t)&127)<<i*7)>>>0,r.get(t++)<128)return s}if(e.length-t>4){for(;i<5;++i)if(s.hi=(s.hi|(r.get(t)&127)<<i*7+3)>>>0,r.get(t++)<128)return s}else if(t<e.byteLength)for(;i<5;++i){if(t>=e.length)throw RangeError(`index out of range: ${t} > ${e.length}`);if(s.hi=(s.hi|(r.get(t)&127)<<i*7+3)>>>0,r.get(t++)<128)return s}throw RangeError("invalid varint encoding")}};var Oa=Math.pow(2,7),Ma=Math.pow(2,14),La=Math.pow(2,21),Fa=Math.pow(2,28),Pa=Math.pow(2,35),Na=Math.pow(2,42),za=Math.pow(2,49),Ia=Math.pow(2,56),Ra=Math.pow(2,63),fe={encodingLength(n){return n<Oa?1:n<Ma?2:n<La?3:n<Fa?4:n<Pa?5:n<Na?6:n<za?7:n<Ia?8:n<Ra?9:10},encode(n,e,t=0){if(Number.MAX_SAFE_INTEGER!=null&&n>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return e==null&&(e=te(fe.encodingLength(n))),I.fromNumber(n).toBytes(e,t),e},decode(n,e=0){return I.fromBytes(n,e).toNumber(!0)}};function As(n){return globalThis?.Buffer?.allocUnsafe!=null?globalThis.Buffer.allocUnsafe(n):new Uint8Array(n)}var it=n=>{let e=fe.encodingLength(n),t=As(e);return fe.encode(n,t),it.bytes=e,t};it.bytes=0;function ot(n){n=n??{};let e=n.lengthEncoder??it;return async function*(r){for await(let s of r){let i=e(s.byteLength);i instanceof Uint8Array?yield i:yield*i,s instanceof Uint8Array?yield s:yield*s}}}ot.single=(n,e)=>{e=e??{};let t=e.lengthEncoder??it;return new Z(t(n.byteLength),n)};var Ie=M(Qt(),1),ja=8,Ua=1024*1024*4,pe;(function(n){n[n.LENGTH=0]="LENGTH",n[n.DATA=1]="DATA"})(pe||(pe={}));var Yt=n=>{let e=fe.decode(n);return Yt.bytes=fe.encodingLength(e),e};Yt.bytes=0;function Re(n){return async function*(t){let r=new Z,s=pe.LENGTH,i=-1,o=n?.lengthDecoder??Yt,a=n?.maxLengthLength??ja,c=n?.maxDataLength??Ua;for await(let u of t)for(r.append(u);r.byteLength>0;){if(s===pe.LENGTH)try{if(i=o(r),i<0)throw(0,Ie.default)(new Error("invalid message length"),"ERR_INVALID_MSG_LENGTH");if(i>c)throw(0,Ie.default)(new Error("message length too long"),"ERR_MSG_DATA_TOO_LONG");let l=o.bytes;r.consume(l),n?.onLength!=null&&n.onLength(i),s=pe.DATA}catch(l){if(l instanceof RangeError){if(r.byteLength>a)throw(0,Ie.default)(new Error("message length length too long"),"ERR_MSG_LENGTH_TOO_LONG");break}throw l}if(s===pe.DATA){if(r.byteLength<i)break;let l=r.sublist(0,i);r.consume(i),n?.onData!=null&&n.onData(l),yield l,s=pe.LENGTH}}if(r.byteLength>0)throw(0,Ie.default)(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}}Re.fromReader=(n,e)=>{let t=1,r=async function*(){for(;;)try{let{done:i,value:o}=await n.next(t);if(i===!0)return;o!=null&&(yield o)}catch(i){if(i.code==="ERR_UNDER_READ")return{done:!0,value:null};throw i}finally{t=1}}();return Re({...e??{},onLength:i=>{t=i}})(r)};var at=class{constructor(e){if(!(e>0)||(e-1&e)!==0)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){let e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}},Ce=class{constructor(e={}){this.hwm=e.splitLimit??16,this.head=new at(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return e?.byteLength!=null?e.byteLength:1}push(e){if(e?.value!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){let t=this.head;this.head=t.next=new at(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){let t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return e?.value!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}};function Ts(n={}){return Ha(t=>{let r=t.shift();if(r==null)return{done:!0};if(r.error!=null)throw r.error;return{done:r.done===!0,value:r.value}},n)}function Ha(n,e){e=e??{};let t=e.onEnd,r=new Ce,s,i,o,a=async()=>r.isEmpty()?o?{done:!0}:await new Promise((d,w)=>{i=x=>{i=null,r.push(x);try{d(n(r))}catch(T){w(T)}return s}}):n(r),c=d=>i!=null?i(d):(r.push(d),s),u=d=>(r=new Ce,i!=null?i({error:d}):(r.push({error:d}),s)),l=d=>{if(o)return s;if(e?.objectMode!==!0&&d?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return c({done:!1,value:d})},h=d=>o?s:(o=!0,d!=null?u(d):c({done:!0})),g=()=>(r=new Ce,h(),{done:!0}),B=d=>(h(d),{done:!0});if(s={[Symbol.asyncIterator](){return this},next:a,return:g,throw:B,push:l,end:h,get readableLength(){return r.size}},t==null)return s;let f=s;return s={[Symbol.asyncIterator](){return this},next(){return f.next()},throw(d){return f.throw(d),t!=null&&(t(d),t=void 0),{done:!0}},return(){return f.return(),t!=null&&(t(),t=void 0),{done:!0}},push:l,end(d){return f.end(d),t!=null&&(t(d),t=void 0),s},get readableLength(){return f.readableLength}},s}var js=M(Rs(),1),$a=(...n)=>{let e;for(;n.length>0;)e=n.shift()(e);return e},Us=n=>n!=null&&(typeof n[Symbol.asyncIterator]=="function"||typeof n[Symbol.iterator]=="function"||typeof n.next=="function"),tr=n=>n!=null&&typeof n.sink=="function"&&Us(n.source),Ga=n=>e=>{let t=n.sink(e);if(t.then!=null){let r=Ts({objectMode:!0});return t.then(()=>{r.end()},i=>{r.end(i)}),(0,js.default)(r,async function*(){yield*n.source,r.end()}())}return n.source};function rr(n,...e){if(tr(n)){let r=n;n=()=>r.source}else if(Us(n)){let r=n;n=()=>r}let t=[n,...e];if(t.length>1&&tr(t[t.length-1])&&(t[t.length-1]=t[t.length-1].sink),t.length>2)for(let r=1;r<t.length-1;r++)tr(t[r])&&(t[r]=Ga(t[r]));return $a(...t)}var nr=Symbol.for("@libp2p/topology");var Ws=()=>{},sr=class{constructor(e){this.min=e.min??0,this.max=e.max??1/0,this.peers=new Set,this.onConnect=e.onConnect??Ws,this.onDisconnect=e.onDisconnect??Ws}get[Symbol.toStringTag](){return nr.toString()}get[nr](){return!0}async setRegistrar(e){this.registrar=e}disconnect(e){this.onDisconnect(e)}};function Hs(n){return new sr(n)}var Ys=M(Ks(),1);var Ue=class extends Error{constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function Xs(n){if(n!=null){if(typeof n[Symbol.iterator]=="function")return n[Symbol.iterator]();if(typeof n[Symbol.asyncIterator]=="function")return n[Symbol.asyncIterator]();if(typeof n.next=="function")return n}throw new Error("argument is not an iterator or iterable")}function Zs(n,e,t){let r=t??{},s=Xs(n);async function*i(){let o,a=()=>{o?.()};for(e.addEventListener("abort",a);;){let c;try{if(e.aborted){let{abortMessage:l,abortCode:h}=r;throw new Ue(l,h)}let u=new Promise((l,h)=>{o=()=>{let{abortMessage:g,abortCode:B}=r;h(new Ue(g,B))}});c=await Promise.race([u,s.next()]),o=null}catch(u){e.removeEventListener("abort",a);let l=u.type==="aborted"&&e.aborted;if(l&&r.onAbort!=null&&await r.onAbort(n),typeof s.return=="function")try{let h=s.return();h instanceof Promise&&h.catch(g=>{r.onReturnError!=null&&r.onReturnError(g)})}catch(h){r.onReturnError!=null&&r.onReturnError(h)}if(l&&r.returnOnAbort===!0)return;throw u}if(c.done===!0)break;yield c.value}e.removeEventListener("abort",a)}return i()}var or="/ipfs/bitswap/1.0.0",ar="/ipfs/bitswap/1.1.0",cr="/ipfs/bitswap/1.2.0",Xa=32,Za=128,Ya=3e4,ut=class{constructor(e,t,r,s={}){this._log=H(e.peerId,"network"),this._libp2p=e,this._bitswap=t,this._protocols=[or],s.b100Only||(this._protocols.unshift(ar),this._protocols.unshift(cr)),this._stats=r,this._running=!1,this._onPeerConnect=this._onPeerConnect.bind(this),this._onPeerDisconnect=this._onPeerDisconnect.bind(this),this._onConnection=this._onConnection.bind(this),this._hashLoader=s.hashLoader,this._maxInboundStreams=s.maxInboundStreams??Xa,this._maxOutboundStreams=s.maxOutboundStreams??Za,this._incomingStreamTimeout=s.incomingStreamTimeout??Ya}async start(){this._running=!0,await this._libp2p.handle(this._protocols,this._onConnection,{maxInboundStreams:this._maxInboundStreams,maxOutboundStreams:this._maxOutboundStreams});let e=Hs({onConnect:this._onPeerConnect,onDisconnect:this._onPeerDisconnect});this._registrarIds=[];for(let t of this._protocols)this._registrarIds.push(await this._libp2p.registrar.register(t,e));this._libp2p.getConnections().forEach(t=>{this._onPeerConnect(t.remotePeer)})}async stop(){if(this._running=!1,await this._libp2p.unhandle(this._protocols),this._registrarIds!=null){for(let e of this._registrarIds)this._libp2p.registrar.unregister(e);this._registrarIds=[]}}_onConnection({stream:e,connection:t}){if(!this._running)return;let r=new Ys.TimeoutController(this._incomingStreamTimeout);Promise.resolve().then(async()=>{this._log("incoming new bitswap %s connection from %p",e.stat.protocol,t.remotePeer),await rr(Zs(e.source,r.signal),Re(),async s=>{for await(let i of s){try{let o=await k.deserialize(i.subarray(),this._hashLoader);await this._bitswap._receiveMessage(t.remotePeer,o)}catch(o){this._bitswap._receiveError(o);break}r.reset()}})}).catch(s=>{this._log(s),e.abort(s)}).finally(()=>{r.clear(),e.close()})}_onPeerConnect(e){this._bitswap._onPeerConnected(e)}_onPeerDisconnect(e){this._bitswap._onPeerDisconnected(e)}findProviders(e,t={}){return this._libp2p.contentRouting.findProviders(e,t)}async findAndConnect(e,t){let r=[],s=0;for await(let i of this.findProviders(e,t))if(this._log(`connecting to provider ${i.id}`),r.push(this.connectTo(i.id,t).catch(o=>{this._log.error(o)})),s++,s===3)break;await Promise.all(r)}async provide(e,t){await this._libp2p.contentRouting.provide(e,t)}async sendMessage(e,t){if(!this._running)throw new Error("network isn't running");let r=e.toString();this._log("sendMessage to %s",r,t);let i=await(await this._libp2p.dial(e)).newStream([cr,ar,or]);await ec(i,t,this._log),this._updateSentStats(e,t.blocks)}async connectTo(e,t){if(!this._running)throw new Error("network isn't running");return this._libp2p.dial(e,t)}_updateSentStats(e,t){let r=e.toString();if(this._stats){for(let s of t.values())this._stats.push(r,"dataSent",s.length);this._stats.push(r,"blocksSent",t.size)}}};async function ec(n,e,t){try{let r;switch(n.stat.protocol){case or:r=e.serializeToBitswap100();break;case ar:case cr:r=e.serializeToBitswap110();break;default:throw new Error("Unknown protocol: "+n.stat.protocol)}await rr([r],ot(),n)}catch(r){t(r)}finally{n.close()}}var lt=class{constructor(e){this.partner=e,this.wantlist=new J,this.exchangeCount=0,this.sentToPeer=new Map,this.accounting={bytesSent:0,bytesRecv:0}}sentBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.accounting.bytesSent+=e}receivedBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.accounting.bytesRecv+=e}wants(e,t,r){this.wantlist.add(e,t,r)}cancelWant(e){this.wantlist.remove(e)}wantlistContains(e){return this.wantlist.get(e)}debtRatio(){return this.accounting.bytesSent/(this.accounting.bytesRecv+1)}};var We=class extends Map{constructor(e,t){super(),this._cmp=t||this._defaultSort,this._keys=[];for(let[r,s]of e||[])this.set(r,s)}update(e){if(e<0||e>=this._keys.length)return;let t=this._keys[e];this._keys.splice(e,1);let r=this._find(t);this._keys.splice(r,0,t)}set(e,t){if(this.has(e)){let s=this.indexOf(e);this._keys.splice(s,1)}super.set(e,t);let r=this._find(e);return this._keys.splice(r,0,e),this}clear(){super.clear(),this._keys=[]}delete(e){if(!this.has(e))return!1;let t=this.indexOf(e);return this._keys.splice(t,1),super.delete(e)}indexOf(e){if(!this.has(e))return-1;let t=this._find(e);if(this._keys[t]===e)return t;for(let r=1;r<this._keys.length;r++){if(this._keys[t+r]===e)return t+r;if(this._keys[t-r]===e)return t-r}return-1}_find(e){let t=0,r=this._keys.length;for(;t<r;){let s=t+r>>>1,i=this._kCmp(this._keys[s],e);if(i<0)t=s+1;else if(i>0)r=s;else return s}return t}*keys(){for(let e of this._keys)yield e}*values(){for(let e of this._keys)yield this.get(e)}*entries(){for(let e of this._keys)yield[e,this.get(e)]}*[Symbol.iterator](){yield*this.entries()}forEach(e,t){if(!!e)for(let r of this._keys)e.apply(t,[[r,this.get(r)]])}_defaultSort(e,t){return e[0]<t[0]?-1:t[0]<e[0]?1:0}_kCmp(e,t){return this._cmp([e,this.get(e)],[t,this.get(t)])}};var tc={hasNewInfo(){return!1},merge(){}},ht=class{constructor(e=tc){this._taskMerger=e,this._byPeer=new We([],ft.compare)}pushTasks(e,t){let r=this._byPeer.get(e.toString());r||(r=new ft(e,this._taskMerger)),r.pushTasks(t),this._byPeer.set(e.toString(),r)}popTasks(e){let t=this._head();if(t===void 0)return{tasks:[],pendingSize:0};let{tasks:r,pendingSize:s}=t.popTasks(e);if(r.length===0)return{tasks:r,pendingSize:s};let i=t.peerId;return t.isIdle()?this._byPeer.delete(i.toString()):this._byPeer.update(0),{peerId:i,tasks:r,pendingSize:s}}_head(){if(this._byPeer.size!==0)for(let[,e]of this._byPeer)return e}remove(e,t){let r=this._byPeer.get(t.toString());r&&r.remove(e)}tasksDone(e,t){let r=this._byPeer.get(e.toString());if(!r)return;let s=this._byPeer.indexOf(e.toString());for(let i of t)r.taskDone(i);this._byPeer.update(s)}},ft=class{constructor(e,t){this.peerId=e,this._taskMerger=t,this._activeTotalSize=0,this._pending=new ur,this._active=new Set}pushTasks(e){for(let t of e)this._pushTask(t)}_pushTask(e){if(!this._taskHasMoreInfoThanActiveTasks(e))return;let t=this._pending.get(e.topic);if(t){e.priority>t.priority&&this._pending.updatePriority(e.topic,e.priority),this._taskMerger.merge(e,t);return}this._pending.add(e)}_taskHasMoreInfoThanActiveTasks(e){let t=[];for(let r of this._active)r.topic===e.topic&&t.push(r);return t.length===0?!0:this._taskMerger.hasNewInfo(e,t)}popTasks(e){let t=0,r=[],s=this._pending.tasks();for(let i=0;i<s.length&&t<e;i++){let o=s[i];r.push(o),t+=o.size,this._pending.delete(o.topic),this._activeTotalSize+=o.size,this._active.add(o)}return{tasks:r,pendingSize:this._pending.totalSize}}taskDone(e){this._active.has(e)&&(this._activeTotalSize-=e.size,this._active.delete(e))}remove(e){this._pending.delete(e)}isIdle(){return this._pending.length===0&&this._active.size===0}static compare(e,t){return e[1]._pending.length===0?1:t[1]._pending.length===0?-1:e[1]._activeTotalSize===t[1]._activeTotalSize?t[1]._pending.length-e[1]._pending.length:e[1]._activeTotalSize-t[1]._activeTotalSize}},ur=class{constructor(){this._tasks=new We([],this._compare)}get length(){return this._tasks.size}get totalSize(){return[...this._tasks.values()].reduce((e,t)=>e+t.task.size,0)}get(e){return(this._tasks.get(e)||{}).task}add(e){this._tasks.set(e.topic,{created:Date.now(),task:e})}delete(e){this._tasks.delete(e)}tasks(){return[...this._tasks.values()].map(e=>e.task)}updatePriority(e,t){let r=this._tasks.get(e);if(!r)return;let s=this._tasks.indexOf(e);r.task.priority=t,this._tasks.update(s)}_compare(e,t){return e[1].task.priority===t[1].task.priority?e[1].created-t[1].created:t[1].task.priority-e[1].task.priority}};var ei={hasNewInfo(n,e){let t=!1,r=!1;for(let s of e)s.data.haveBlock&&(t=!0),s.data.isWantBlock&&(r=!0);return!!(!r&&n.data.isWantBlock||!t&&n.data.haveBlock)},merge(n,e){let t=n.data,r=e.data;!r.haveBlock&&t.haveBlock&&(r.haveBlock=t.haveBlock,r.blockSize=t.blockSize),!r.isWantBlock&&t.isWantBlock&&(r.isWantBlock=!0,(!r.haveBlock||t.haveBlock)&&(r.haveBlock=t.haveBlock,e.size=n.size)),r.isWantBlock&&r.haveBlock&&(e.size=r.blockSize)}};var ti=k.WantType,rc=16*1024,nc=1024,pt=class{constructor(e,t,r,s,i,o={}){this._log=H(e,"engine"),this.blockstore=t,this.network=r,this._stats=s,this._opts=this._processOpts(o),this.ledgerMap=oe({system:"ipfs",component:"bitswap",metric:"ledger-map",metrics:i.metrics}),this._running=!1,this._requestQueue=new ht(ei)}_processOpts(e){return{maxSizeReplaceHasWithBlock:nc,targetMessageSize:rc,...e}}_scheduleProcessTasks(){setTimeout(()=>{this._processTasks()})}async _processTasks(){if(!this._running)return;let{peerId:e,tasks:t,pendingSize:r}=this._requestQueue.popTasks(this._opts.targetMessageSize);if(t.length===0)return;let s=new k(!1);s.setPendingBytes(r);let i=[],o=new Map;for(let c of t){let u=_.parse(c.topic);c.data.haveBlock?c.data.isWantBlock?(i.push(u),o.set(c.topic,c.data)):s.addHave(u):s.addDontHave(u)}let a=await this._getBlocks(i);for(let[c,u]of o){let l=_.parse(c),h=a.get(c);h?s.addBlock(l,h):u.sendDontHave&&s.addDontHave(l)}if(s.empty){e&&this._requestQueue.tasksDone(e,t),this._scheduleProcessTasks();return}try{e&&await this.network.sendMessage(e,s);for(let[c,u]of a.entries())e&&this.messageSent(e,_.parse(c),u)}catch(c){this._log.error(c)}e&&this._requestQueue.tasksDone(e,t),this._scheduleProcessTasks()}wantlistForPeer(e){let t=e.toString(),r=this.ledgerMap.get(t);return r?r.wantlist.sortedEntries():new Map}ledgerForPeer(e){let t=e.toString(),r=this.ledgerMap.get(t);return r?{peer:r.partner,value:r.debtRatio(),sent:r.accounting.bytesSent,recv:r.accounting.bytesRecv,exchanged:r.exchangeCount}:null}peers(){return Array.from(this.ledgerMap.values()).map(e=>e.partner)}receivedBlocks(e){if(!!e.length){for(let t of this.ledgerMap.values())for(let r of e){let s=t.wantlistContains(r.cid);if(!s)continue;let i=r.data.length,o=this._sendAsBlock(s.wantType,i),a=i;o||(a=k.blockPresenceSize(s.cid)),this._requestQueue.pushTasks(t.partner,[{topic:s.cid.toString(D),priority:s.priority,size:a,data:{blockSize:i,isWantBlock:o,haveBlock:!0,sendDontHave:!1}}])}this._scheduleProcessTasks()}}async messageReceived(e,t){let r=this._findOrCreate(e);if(t.empty)return;if(t.full&&(r.wantlist=new J),this._updateBlockAccounting(t.blocks,r),t.wantlist.size===0){this._scheduleProcessTasks();return}let s=[],i=[];t.wantlist.forEach(o=>{o.cancel?(r.cancelWant(o.cid),s.push(o.cid)):(r.wants(o.cid,o.priority,o.wantType),i.push(o))}),this._cancelWants(e,s),await this._addWants(e,i),this._scheduleProcessTasks()}_cancelWants(e,t){for(let r of t)this._requestQueue.remove(r.toString(D),e)}async _addWants(e,t){let r=await this._getBlockSizes(t.map(i=>i.cid)),s=[];for(let i of t){let o=i.cid.toString(D),a=r.get(o);if(a==null)i.sendDontHave&&s.push({topic:o,priority:i.priority,size:k.blockPresenceSize(i.cid),data:{isWantBlock:i.wantType===ti.Block,blockSize:0,haveBlock:!1,sendDontHave:i.sendDontHave}});else{let c=this._sendAsBlock(i.wantType,a),u=a;c||(u=k.blockPresenceSize(i.cid)),s.push({topic:o,priority:i.priority,size:u,data:{isWantBlock:c,blockSize:a,haveBlock:!0,sendDontHave:i.sendDontHave}})}this._requestQueue.pushTasks(e,s)}}_sendAsBlock(e,t){return e===ti.Block||t<=this._opts.maxSizeReplaceHasWithBlock}async _getBlockSizes(e){let t=await this._getBlocks(e);return new Map([...t].map(([r,s])=>[r,s.length]))}async _getBlocks(e){let t=new Map;return await Promise.all(e.map(async r=>{try{let s=await this.blockstore.get(r);t.set(r.toString(D),s)}catch(s){s.code!=="ERR_NOT_FOUND"&&this._log.error("failed to query blockstore for %s: %s",r,s)}})),t}_updateBlockAccounting(e,t){for(let r of e.values())this._log("got block (%s bytes)",r.length),t.receivedBytes(r.length)}messageSent(e,t,r){let s=this._findOrCreate(e);s.sentBytes(r.length),s.wantlist.remove(t)}numBytesSentTo(e){return this._findOrCreate(e).accounting.bytesSent}numBytesReceivedFrom(e){return this._findOrCreate(e).accounting.bytesRecv}peerDisconnected(e){this.ledgerMap.delete(e.toString())}_findOrCreate(e){let t=e.toString(),r=this.ledgerMap.get(t);if(r)return r;let s=new lt(e);return this.ledgerMap.set(t,s),this._stats&&this._stats.push(t,"peerCount",1),s}start(){this._running=!0}stop(){this._running=!1}};var Di=M(yt(),1);var hr={};P(hr,{identity:()=>lc});var lc=we({prefix:"\0",name:"identity",encode:n=>Lr(n),decode:n=>Mr(n)});var fr={};P(fr,{base2:()=>hc});var hc=C({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var pr={};P(pr,{base8:()=>fc});var fc=C({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var dr={};P(dr,{base10:()=>pc});var pc=re({prefix:"9",name:"base10",alphabet:"0123456789"});var gr={};P(gr,{base16:()=>dc,base16upper:()=>gc});var dc=C({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),gc=C({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var yr={};P(yr,{base36:()=>yc,base36upper:()=>bc});var yc=re({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),bc=re({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var br={};P(br,{base64:()=>mc,base64pad:()=>wc,base64url:()=>Dc,base64urlpad:()=>_c});var mc=C({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),wc=C({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Dc=C({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),_c=C({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});var mr={};P(mr,{base256emoji:()=>xc});var fi=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),vc=fi.reduce((n,e,t)=>(n[t]=e,n),[]),kc=fi.reduce((n,e,t)=>(n[e.codePointAt(0)]=t,n),[]);function Ec(n){return n.reduce((e,t)=>(e+=vc[t],e),"")}function Cc(n){let e=[];for(let t of n){let r=kc[t.codePointAt(0)];if(r===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(r)}return new Uint8Array(e)}var xc=we({prefix:"\u{1F680}",name:"base256emoji",encode:Ec,decode:Cc});var wr={};P(wr,{identity:()=>Ac});var pi=0,Sc="identity",di=Y,Bc=n=>ce(pi,di(n)),Ac={code:pi,name:Sc,encode:di,digest:Bc};var Wh=new TextEncoder,Hh=new TextDecoder;var Dr={...hr,...fr,...pr,...dr,...gr,...St,...yr,...xt,...br,...mr},Gh={...Tt,...wr};function yi(n,e,t,r){return{name:n,prefix:e,encoder:{name:n,prefix:e,encode:t},decoder:{decode:r}}}var gi=yi("utf8","u",n=>{let e=new TextDecoder("utf8");return"u"+e.decode(n)},n=>new TextEncoder().encode(n.substring(1))),_r=yi("ascii","a",n=>{let e="a";for(let t=0;t<n.length;t++)e+=String.fromCharCode(n[t]);return e},n=>{n=n.substring(1);let e=te(n.length);for(let t=0;t<n.length;t++)e[t]=n.charCodeAt(t);return e}),Mc={utf8:gi,"utf-8":gi,hex:Dr.base16,latin1:_r,ascii:_r,binary:_r,...Dr},bi=Mc;function vr(n,e="utf8"){let t=bi[e];if(!t)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?globalThis.Buffer.from(n.buffer,n.byteOffset,n.byteLength).toString("utf8"):t.encoder.encode(n).substring(1)}var mi=n=>`unwant:${vr(n.multihash.bytes,"base64")}`,wi=n=>`block:${vr(n.multihash.bytes,"base64")}`,bt=class extends Di.EventEmitter{constructor(e){super(),this.setMaxListeners(ks),this._log=H(e,"notif")}hasBlock(e,t){let r=wi(e);this._log(r),this.emit(r,t)}wantBlock(e,t={}){if(!e)throw new Error("Not a valid cid");let r=wi(e),s=mi(e);return this._log(`wantBlock:${e}`),new Promise((i,o)=>{let a=()=>{this.removeListener(r,c),o(new Error(`Block for ${e} unwanted`))},c=u=>{this.removeListener(s,a),i(u)};this.once(s,a),this.once(r,c),t&&t.signal&&t.signal.addEventListener("abort",()=>{this.removeListener(r,c),this.removeListener(s,a),o(new Error(`Want for ${e} aborted`))})})}unwantBlock(e){let t=mi(e);this._log(t),this.emit(t)}};var xi=M(yt(),1);var Ei=M(yt(),1),kr=M(ki(),1),He=class extends Ei.EventEmitter{constructor(e,t){super(),this._options=t,this._queue=[],this._stats={},this._frequencyLastTime=Date.now(),this._frequencyAccumulators={},this._movingAverages={},this._update=this._update.bind(this),e.forEach(r=>{this._stats[r]=BigInt(0),this._movingAverages[r]={},this._options.movingAverageIntervals.forEach(s=>{(this._movingAverages[r][s]=(0,kr.default)(s)).push(this._frequencyLastTime,0)})}),this._enabled=this._options.enabled}enable(){this._enabled=!0}disable(){this._disabled=!0}stop(){this._timeout&&clearTimeout(this._timeout)}get snapshot(){return Object.assign({},this._stats)}get movingAverages(){return Object.assign({},this._movingAverages)}push(e,t){this._enabled&&(this._queue.push([e,t,Date.now()]),this._resetComputeTimeout())}_resetComputeTimeout(){this._timeout&&clearTimeout(this._timeout),this._timeout=setTimeout(this._update,this._nextTimeout())}_nextTimeout(){let e=this._queue.length/this._options.computeThrottleMaxQueueSize;return Math.max(this._options.computeThrottleTimeout*(1-e),0)}_update(){if(this._timeout=null,this._queue.length){let e;for(;this._queue.length;){let t=e=this._queue.shift();t&&this._applyOp(t)}e&&this._updateFrequency(e[2]),this.emit("update",this._stats)}}_updateFrequency(e){let t=e-this._frequencyLastTime;t&&Object.keys(this._stats).forEach(r=>{this._updateFrequencyFor(r,t,e)}),this._frequencyLastTime=e}_updateFrequencyFor(e,t,r){let s=this._frequencyAccumulators[e]||0;this._frequencyAccumulators[e]=0;let i=s/t*1e3,o=this._movingAverages[e];o||(o=this._movingAverages[e]={}),this._options.movingAverageIntervals.forEach(a=>{let c=o[a];c||(c=o[a]=(0,kr.default)(a)),c.push(r,i)})}_applyOp(e){let t=e[0],r=e[1];if(typeof r!="number")throw new Error(`invalid increment number: ${r}`);Object.prototype.hasOwnProperty.call(this._stats,t)||(this._stats[t]=BigInt(0)),this._stats[t]=BigInt(this._stats[t])+BigInt(r),this._frequencyAccumulators[t]||(this._frequencyAccumulators[t]=0),this._frequencyAccumulators[t]+=r}};var Ci={enabled:!1,computeThrottleTimeout:1e3,computeThrottleMaxQueueSize:1e3,movingAverageIntervals:[60*1e3,5*60*1e3,15*60*1e3]},mt=class extends xi.EventEmitter{constructor(e,t=[],r=Ci){super();let s=Object.assign({},Ci,r);if(typeof s.computeThrottleTimeout!="number")throw new Error("need computeThrottleTimeout");if(typeof s.computeThrottleMaxQueueSize!="number")throw new Error("need computeThrottleMaxQueueSize");this._initialCounters=t,this._options=s,this._enabled=this._options.enabled,this._global=new He(t,s),this._global.on("update",i=>this.emit("update",i)),this._peers=oe({system:"ipfs",component:"bitswap",metric:"stats-peers",metrics:e.metrics})}enable(){this._enabled=!0,this._options.enabled=!0,this._global.enable()}disable(){this._enabled=!1,this._options.enabled=!1,this._global.disable()}stop(){this._enabled=!1,this._global.stop();for(let e of this._peers)e[1].stop()}get snapshot(){return this._global.snapshot}get movingAverages(){return this._global.movingAverages}forPeer(e){let t=typeof e!="string"&&e.toString?e.toString():`${e}`;return this._peers.get(t)}push(e,t,r){if(this._enabled&&(this._global.push(t,r),e)){let s=this._peers.get(e);s||(s=new He(this._initialCounters,this._options),this._peers.set(e,s)),s.push(t,r)}}disconnected(e){let t=e.toString(),r=this._peers.get(t);r&&(r.stop(),this._peers.delete(t))}};var Ri=M(Bi(),1);var Cr=M(Ti(),1),de=M(Mi(),1),xr=M(Fi(),1),Ii=M(Ni(),1),zi=(n,e)=>async function*(){yield*(await(0,Ii.default)(n)).sort(e)}(),wt=class{open(){return Promise.reject(new Error(".open is not implemented"))}close(){return Promise.reject(new Error(".close is not implemented"))}put(e,t,r){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(let{key:r,value:s}of e)await this.put(r,s,t),yield{key:r,value:s}}async*getMany(e,t={}){for await(let r of e)yield this.get(r,t)}async*deleteMany(e,t={}){for await(let r of e)await this.delete(r,t),yield r}batch(){let e=[],t=[];return{put(r,s){e.push({key:r,value:s})},delete(r){t.push(r)},commit:async r=>{await(0,Cr.default)(this.putMany(e,r)),e=[],await(0,Cr.default)(this.deleteMany(t,r)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let r=this._all(e,t);if(e.prefix!=null&&(r=(0,de.default)(r,s=>s.key.toString().startsWith(e.prefix||""))),Array.isArray(e.filters)&&(r=e.filters.reduce((s,i)=>(0,de.default)(s,i),r)),Array.isArray(e.orders)&&(r=e.orders.reduce((s,i)=>zi(s,i),r)),e.offset!=null){let s=0;r=(0,de.default)(r,()=>s++>=(e.offset||0))}return e.limit!=null&&(r=(0,xr.default)(r,e.limit)),r}queryKeys(e,t){let r=this._allKeys(e,t);if(e.prefix!=null&&(r=(0,de.default)(r,s=>s.toString().startsWith(e.prefix||""))),Array.isArray(e.filters)&&(r=e.filters.reduce((s,i)=>(0,de.default)(s,i),r)),Array.isArray(e.orders)&&(r=e.orders.reduce((s,i)=>zi(s,i),r)),e.offset!=null){let s=0;r=(0,de.default)(r,()=>s++>=e.offset)}return e.limit!=null&&(r=(0,xr.default)(r,e.limit)),r}};var Ic={statsEnabled:!1,statsComputeThrottleTimeout:1e3,statsComputeThrottleMaxQueueSize:1e3},Rc=["blocksReceived","dataReceived","dupBlksReceived","dupDataReceived","blocksSent","dataSent","providesBufferLength","wantListLength","peerCount"],Dt=class extends wt{constructor(e,t,r={}){super(),this._libp2p=e,this._log=H(this.peerId),this._options=Object.assign({},Ic,r),this._stats=new mt(e,Rc,{enabled:this._options.statsEnabled,computeThrottleTimeout:this._options.statsComputeThrottleTimeout,computeThrottleMaxQueueSize:this._options.statsComputeThrottleMaxQueueSize}),this.network=new ut(e,this,this._stats,{hashLoader:r.hashLoader,maxInboundStreams:r.maxInboundStreams,maxOutboundStreams:r.maxOutboundStreams,incomingStreamTimeout:r.incomingStreamTimeout}),this.blockstore=t,this.engine=new pt(this.peerId,t,this.network,this._stats,e),this.wm=new nt(this.peerId,this.network,this._stats,e),this.notifications=new bt(this.peerId),this.started=!1}isStarted(){return this.started}get peerId(){return this._libp2p.peerId}async _receiveMessage(e,t){try{await this.engine.messageReceived(e,t)}catch{this._log("failed to receive message",t)}if(t.blocks.size===0)return;let r=[];for(let[s,i]of t.blocks.entries()){let o=_.parse(s);r.push({wasWanted:this.wm.wantlist.contains(o),cid:o,data:i})}this.wm.cancelWants(r.filter(({wasWanted:s})=>s).map(({cid:s})=>s)),await Promise.all(r.map(({cid:s,wasWanted:i,data:o})=>this._handleReceivedBlock(e,s,o,i)))}async _handleReceivedBlock(e,t,r,s){this._log("received block");let i=await this.blockstore.has(t);this._updateReceiveCounters(e.toString(),t,r,i),s&&await this.put(t,r)}_updateReceiveCounters(e,t,r,s){this._stats.push(e,"blocksReceived",1),this._stats.push(e,"dataReceived",r.length),s&&(this._stats.push(e,"dupBlksReceived",1),this._stats.push(e,"dupDataReceived",r.length))}_receiveError(e){this._log.error("ReceiveError: %s",e.message)}_onPeerConnected(e){this.wm.connected(e)}_onPeerDisconnected(e){this.wm.disconnected(e),this.engine.peerDisconnected(e),this._stats.disconnected(e)}enableStats(){this._stats.enable()}disableStats(){this._stats.disable()}wantlistForPeer(e,t){return this.engine.wantlistForPeer(e)}ledgerForPeer(e){return this.engine.ledgerForPeer(e)}async get(e,t={}){let r=(c,u)=>(this.wm.wantBlocks([c],u),this.notifications.wantBlock(c,u)),s=!1,i=async(c,u)=>{try{return await this.blockstore.get(c,u)}catch(l){if(l.code!=="ERR_NOT_FOUND")throw l;return s||(s=!0,this.network.findAndConnect(c,u).catch(h=>this._log.error(h))),r(c,u)}},o=new AbortController,a=t.signal?(0,Ri.anySignal)([t.signal,o.signal]):o.signal;try{return await Promise.race([this.notifications.wantBlock(e,{signal:a}),i(e,{signal:a})])}finally{o.abort()}}async*getMany(e,t={}){for await(let r of e)yield this.get(r,t)}unwant(e){let t=Array.isArray(e)?e:[e];this.wm.unwantBlocks(t),t.forEach(r=>this.notifications.unwantBlock(r))}cancelWants(e){this.wm.cancelWants(Array.isArray(e)?e:[e])}async put(e,t,r){await this.blockstore.put(e,t),this._sendHaveBlockNotifications(e,t)}async*putMany(e,t){for await(let{key:r,value:s}of this.blockstore.putMany(e,t))this._sendHaveBlockNotifications(r,s),yield{key:r,value:s}}_sendHaveBlockNotifications(e,t){this.notifications.hasBlock(e,t),this.engine.receivedBlocks([{cid:e,data:t}]),this.network.provide(e).catch(r=>{this._log.error("Failed to provide: %s",r.message)})}getWantlist(){return this.wm.wantlist.entries()}peers(){return this.engine.peers()}stat(){return this._stats}async start(){this.wm.start(),await this.network.start(),this.engine.start(),this.started=!0}async stop(){this._stats.stop(),this.wm.stop(),await this.network.stop(),this.engine.stop(),this.started=!1}unwrap(){return this.blockstore}};var jc=(n,e,t={})=>new Dt(n,e,t);return Vi(Uc);})();
return IpfsBitswap}));
